# Ent 表操作指南 - 第二步：生成 Ent 代码

本文档是 Ent 表操作指南的第二部分，介绍如何从 Schema 生成 Ent 代码。

## 概述

定义 Schema 后，需要使用 Ent CLI 工具生成对应的 Go 代码。生成的代码包括：
- Entity 类型和查询构建器
- CRUD 操作方法
- 迁移文件
- 类型安全的查询 API

## 生成命令

### 方法 1：使用 go generate（推荐）

在 `internal/data/ent/ent.go` 文件顶部添加 `go:generate` 指令（如果还没有）：

```go
//go:generate go run -mod=mod entgo.io/ent/cmd/ent generate ./schema
```

然后运行：

```bash
cd internal/data/ent
go generate
```

或者从项目根目录运行：

```bash
go generate ./internal/data/ent
```

### 方法 2：直接使用 ent 命令

```bash
cd internal/data/ent
go run -mod=mod entgo.io/ent/cmd/ent generate ./schema
```

### 方法 3：使用 Makefile（如果已配置）

如果 Makefile 中已配置 `generate` 目标：

```bash
make generate
```

## 生成的文件结构

生成后，`internal/data/ent/` 目录结构如下：

```
internal/data/ent/
├── schema/              # Schema 定义（手动编写）
│   ├── order.go
│   └── product.go       # 新添加的 Schema
├── order/               # Order 实体生成的代码
│   ├── order.go
│   ├── order_create.go
│   ├── order_update.go
│   ├── order_query.go
│   └── ...
├── product/             # Product 实体生成的代码（新生成）
│   ├── product.go
│   ├── product_create.go
│   ├── product_update.go
│   ├── product_query.go
│   └── ...
├── client.go            # Ent Client（自动更新）
├── ent.go               # 通用代码
├── migrate/             # 迁移相关代码
│   ├── migrate.go
│   └── schema.go        # 表结构定义（自动更新）
└── runtime.go           # 运行时代码（自动更新）
```

## 验证生成结果

### 1. 检查生成的实体代码

确认新实体的代码已生成，例如 `internal/data/ent/product/product.go`：

```go
package product

// ... 生成的代码 ...
```

### 2. 检查 Client 更新

确认 `internal/data/ent/client.go` 中已包含新实体的客户端：

```go
type Client struct {
	config
	Schema  *migrate.Schema
	Order   *OrderClient
	Product *ProductClient  // 新生成的客户端
}
```

### 3. 检查迁移文件

确认 `internal/data/ent/migrate/schema.go` 中已包含新表定义。

## 常见问题排查

### 问题 1：生成失败 - Schema 语法错误

**错误信息**：
```
ent: failed to generate code: ...
```

**解决方法**：
1. 检查 Schema 文件语法
2. 确认所有导入包正确
3. 检查字段类型和选项是否正确

### 问题 2：生成失败 - 包路径问题

**错误信息**：
```
package ... not found
```

**解决方法**：
```bash
go mod tidy
go generate ./internal/data/ent
```

### 问题 3：Client 未更新

如果生成后 Client 中没有新实体：

1. 确认 Schema 文件在 `schema/` 目录下
2. 确认 Schema 结构体名称正确（首字母大写）
3. 重新运行生成命令

## 修改表后的代码生成

### 场景 1：添加新字段

1. 在 Schema 中添加字段定义
2. 运行生成命令
3. 检查生成的代码是否包含新字段的 Setter/Getter 方法

### 场景 2：修改字段类型

⚠️ **注意**：修改字段类型可能导致数据不兼容

1. 在 Schema 中修改字段类型
2. 运行生成命令
3. 检查生成的代码
4. 需要手动处理数据迁移（见第四步）

### 场景 3：删除字段

1. 从 Schema 中删除字段定义
2. 运行生成命令
3. 检查生成的代码
4. 更新使用该字段的业务代码

## 代码生成最佳实践

### 1. 版本控制

生成的代码应该提交到版本控制系统：

```bash
git add internal/data/ent/
git commit -m "feat: generate ent code for Product entity"
```

### 2. 不要手动修改生成的代码

所有 `// Code generated by ent, DO NOT EDIT.` 标记的文件都不应该手动修改。

### 3. 生成前备份

在重大修改前，建议先提交当前代码：

```bash
git add .
git commit -m "chore: backup before schema changes"
```

### 4. 生成后测试

生成代码后，运行测试确保没有破坏现有功能：

```bash
go test ./internal/data/...
```

## 下一步

完成代码生成后，请继续阅读：

- [第三步：实现 Repository](./ent-table-operations-03-repository-implementation.md) - 实现数据访问层 Repository

