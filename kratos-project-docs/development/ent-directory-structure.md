# Ent 目录结构说明

本文档详细说明 `internal/data/ent` 目录下各个文件的作用，以及哪些是自动生成的。

## 目录结构概览

```
internal/data/ent/
├── schema/              # Schema 定义（手动编写）
│   ├── order.go
│   └── product.go
├── order/               # Order 实体生成的代码
│   ├── order.go
│   └── where.go
├── product/             # Product 实体生成的代码
│   ├── product.go
│   └── where.go
├── predicate/           # 谓词类型定义（自动生成）
│   └── predicate.go
├── hook/                # Hook 工具函数（自动生成）
│   └── hook.go
├── migrate/             # 迁移相关代码（自动生成）
│   ├── migrate.go
│   └── schema.go
├── runtime/             # 运行时配置（自动生成）
│   └── runtime.go
├── enttest/             # 测试工具（自动生成）
│   └── enttest.go
├── client.go            # Ent 客户端（自动生成）
├── ent.go               # 核心工具函数（自动生成）
├── mutation.go           # 变更操作定义（自动生成）
├── tx.go                # 事务支持（自动生成）
├── runtime.go           # 运行时初始化（自动生成）
├── order.go             # Order 实体定义（自动生成）
├── order_create.go       # Order 创建操作（自动生成）
├── order_update.go       # Order 更新操作（自动生成）
├── order_query.go        # Order 查询操作（自动生成）
├── order_delete.go       # Order 删除操作（自动生成）
├── product.go           # Product 实体定义（自动生成）
├── product_create.go     # Product 创建操作（自动生成）
├── product_update.go     # Product 更新操作（自动生成）
├── product_query.go      # Product 查询操作（自动生成）
└── product_delete.go     # Product 删除操作（自动生成）
```

## 文件分类

### ✅ 手动编写的文件（需要手动维护）

#### `schema/` 目录
- **作用**：定义数据库表结构
- **文件**：
  - `schema/order.go` - Order 表的 Schema 定义
  - `schema/product.go` - Product 表的 Schema 定义
- **说明**：这些文件是手动编写的，定义了字段、索引、约束等。修改 Schema 后需要运行 `go generate` 重新生成代码。

### ⚙️ 自动生成的文件（不要手动修改）

所有标记有 `// Code generated by ent, DO NOT EDIT.` 的文件都是自动生成的，不应该手动修改。

#### 核心文件

##### `ent.go` - 核心工具函数
- **作用**：提供 Ent 的核心工具函数和类型定义
- **包含内容**：
  - 类型别名（`Op`、`Hook`、`Query` 等）
  - 错误类型（`NotFoundError`、`ValidationError`、`ConstraintError` 等）
  - 错误检查函数（`IsNotFound()`、`IsValidationError()` 等）
  - 聚合函数（`Count()`、`Max()`、`Min()`、`Sum()`、`Mean()` 等）
  - 查询辅助函数（`Asc()`、`Desc()` 等）

##### `client.go` - Ent 客户端
- **作用**：定义 Ent 客户端，管理所有实体的客户端
- **包含内容**：
  - `Client` 结构体，包含所有实体的客户端（如 `Order *OrderClient`、`Product *ProductClient`）
  - `NewClient()` 函数创建客户端
  - Hooks 和 Interceptors 的管理方法
  - 每个实体的客户端方法（`Order()`、`Product()` 等）

##### `mutation.go` - 变更操作定义
- **作用**：定义所有实体的 Mutation 类型
- **包含内容**：
  - 操作类型常量（`OpCreate`、`OpUpdate`、`OpDelete`、`OpUpdateOne`、`OpDeleteOne`）
  - 实体类型常量（`TypeOrder`、`TypeProduct`）
  - 所有实体的 Mutation 结构体（`OrderMutation`、`ProductMutation`）
  - Mutation 的字段操作方法

##### `tx.go` - 事务支持
- **作用**：提供数据库事务支持
- **包含内容**：
  - `Tx` 事务客户端结构体
  - `Client.Tx()` 方法创建事务
  - `Tx.Commit()` 和 `Tx.Rollback()` 方法
  - 事务中的客户端访问方法

##### `runtime.go` - 运行时初始化
- **作用**：在 `init()` 函数中初始化字段的默认值和验证器
- **包含内容**：
  - 从 Schema 读取字段描述符
  - 设置字段的默认值（如 `order.DefaultStatus`）
  - 设置字段验证器（如 `order.OrderNoValidator`）

#### 实体相关文件（以 Product 为例）

##### `product.go` - Product 实体定义
- **作用**：定义 Product 实体结构体和基础方法
- **包含内容**：
  - `Product` 结构体及其字段
  - 字段的 Getter 方法（`GetName()`、`GetSku()` 等）
  - SQL 扫描逻辑（`scanValues()` 方法）
  - 实体更新方法（`Update()`）

##### `product_create.go` - 创建操作
- **作用**：提供创建 Product 实体的构建器
- **包含内容**：
  - `ProductCreate` 结构体
  - 字段 Setter 方法（`SetName()`、`SetSku()`、`SetPrice()` 等）
  - `Save()` 方法执行数据库插入
  - `SaveX()` 方法（失败时 panic）
  - 批量创建方法（`ProductCreateBulk`）

##### `product_update.go` - 更新操作
- **作用**：提供更新 Product 实体的构建器
- **包含内容**：
  - `ProductUpdate` 结构体（更新多个记录）
  - `ProductUpdateOne` 结构体（更新单个记录）
  - 字段 Setter 方法
  - `Save()` 方法执行数据库更新
  - `Exec()` 方法执行更新但不返回实体

##### `product_query.go` - 查询操作
- **作用**：提供查询 Product 实体的构建器
- **包含内容**：
  - `ProductQuery` 结构体
  - `Where()` 方法添加查询条件
  - `Select()` 方法选择字段
  - `Order()` 方法排序
  - `Limit()` 和 `Offset()` 方法分页
  - `All()` 查询所有记录
  - `Only()` 查询单条记录（必须只有一条）
  - `First()` 查询第一条记录
  - `Count()` 统计记录数

##### `product_delete.go` - 删除操作
- **作用**：提供删除 Product 实体的构建器
- **包含内容**：
  - `ProductDelete` 结构体（删除多个记录）
  - `ProductDeleteOne` 结构体（删除单个记录）
  - `Exec()` 方法执行删除操作

#### 子目录文件

##### `product/product.go` - 实体常量
- **作用**：定义 Product 实体的常量和辅助函数
- **包含内容**：
  - 字段名常量（`FieldID`、`FieldName`、`FieldSku`、`FieldPrice` 等）
  - 表名常量（`Table`）
  - 字段验证函数（`NameValidator`、`SkuValidator` 等）
  - 默认值常量（`DefaultStock` 等）

##### `product/where.go` - 查询条件函数
- **作用**：提供类型安全的查询条件函数
- **包含内容**：
  - `ID()` - 按 ID 查询
  - `IDEQ()`、`IDNEQ()` - ID 等于/不等于
  - `IDIn()`、`IDNotIn()` - ID 在/不在列表中
  - `IDGT()`、`IDGTE()`、`IDLT()`、`IDLTE()` - ID 比较
  - `NameEQ()`、`NameNEQ()`、`NameContains()` - 名称查询
  - `SkuEQ()`、`SkuNEQ()` - SKU 查询
  - `PriceEQ()`、`PriceGT()` 等 - 价格查询
  - `StockEQ()`、`StockGT()` 等 - 库存查询
  - `And()`、`Or()`、`Not()` - 逻辑组合

##### `predicate/predicate.go` - 谓词类型定义
- **作用**：定义谓词函数类型，用于类型安全的查询条件
- **包含内容**：
  - `Order` 函数类型（用于 Order 查询）
  - `Product` 函数类型（用于 Product 查询）

##### `hook/hook.go` - Hook 工具函数
- **作用**：提供 Hook 的链式调用和条件执行工具
- **包含内容**：
  - `OrderFunc`、`ProductFunc` - Hook 函数适配器
  - `Condition` - Hook 条件函数类型
  - `And()`、`Or()`、`Not()` - 条件组合
  - `HasOp()` - 检查操作类型
  - `If()` - 条件执行 Hook
  - `On()` - 指定操作执行 Hook
  - `Unless()` - 排除操作执行 Hook
  - `Chain` - Hook 链

##### `migrate/migrate.go` - 迁移工具
- **作用**：提供数据库迁移的 API
- **包含内容**：
  - `Schema` 结构体
  - `Create()` 方法创建表结构
  - 迁移选项（`WithGlobalUniqueID`、`WithDropColumn` 等）

##### `migrate/schema.go` - 迁移表结构定义
- **作用**：定义所有表的列和索引信息，用于数据库迁移
- **包含内容**：
  - `OrdersColumns` - Order 表的列定义
  - `OrdersTable` - Order 表结构（包含索引）
  - `ProductsColumns` - Product 表的列定义
  - `ProductsTable` - Product 表结构（包含索引）
  - `Tables` - 所有表的列表

##### `runtime/runtime.go` - 运行时配置
- **作用**：提供运行时配置和 Hook 注册
- **说明**：可以在这里注册全局 Hook 和 Interceptor

##### `enttest/enttest.go` - 测试工具
- **作用**：提供测试用的 Ent 客户端创建函数
- **包含内容**：
  - `Open()` - 创建测试客户端并自动运行迁移
  - `NewClient()` - 创建测试客户端
  - 自动迁移功能

## 文件生成规则

### 何时生成
运行以下命令会重新生成所有自动生成的文件：
```bash
cd internal/data/ent
go generate
```

或者：
```bash
go generate ./internal/data/ent
```

### 生成触发条件
- 修改 `schema/` 目录下的 Schema 文件后
- 添加新的 Schema 文件后
- 修改字段、索引、约束后

### 生成的文件特点
1. **所有自动生成的文件**都包含 `// Code generated by ent, DO NOT EDIT.` 注释
2. **不要手动修改**这些文件，修改会被下次生成覆盖
3. **Schema 文件**是唯一需要手动维护的文件

## 使用示例

### 创建实体
```go
product, err := client.Product.Create().
    SetName("iPhone 15").
    SetSku("IPHONE15-001").
    SetPrice(599900).
    SetStock(100).
    SetCreatedAt(time.Now().Unix()).
    SetUpdatedAt(time.Now().Unix()).
    Save(ctx)
```

### 查询实体
```go
// 按 ID 查询
product, err := client.Product.Get(ctx, 1)

// 按条件查询
products, err := client.Product.Query().
    Where(product.NameContains("iPhone")).
    Where(product.PriceGT(500000)).
    Order(product.ByPrice(sql.OrderDesc())).
    Limit(10).
    All(ctx)
```

### 更新实体
```go
product, err := client.Product.UpdateOneID(1).
    SetStock(50).
    SetUpdatedAt(time.Now().Unix()).
    Save(ctx)
```

### 删除实体
```go
err := client.Product.DeleteOneID(1).Exec(ctx)
```

## 注意事项

1. **不要修改自动生成的文件**：所有标记为 `// Code generated by ent, DO NOT EDIT.` 的文件都不应该手动修改
2. **只修改 Schema 文件**：所有表结构变更都应该在 `schema/` 目录下的文件中进行
3. **生成后测试**：生成代码后应该运行测试确保没有破坏现有功能
4. **版本控制**：生成的代码应该提交到版本控制系统，方便团队协作

## 相关文档

- [第一步：定义 Schema](./ent-table-operations-01-schema-definition.md)
- [第二步：生成 Ent 代码](./ent-table-operations-02-code-generation.md)
- [第三步：实现 Repository](./ent-table-operations-03-repository-implementation.md)（待完成）
- [第四步：数据库迁移](./ent-table-operations-04-database-migration.md)（待完成）

