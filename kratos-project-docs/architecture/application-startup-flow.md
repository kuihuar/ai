# 应用启动流程图

本文档描述了 SRE 项目中 4 个应用的启动流程。

## 目录

- [daemon-worker](#1-daemon-worker)
- [cron-worker](#2-cron-worker)
- [sre](#3-sre-主服务)
- [sre-client](#4-sre-client-命令行客户端)

---

## 1. daemon-worker

**用途**：运行常驻后台任务（Daemon Jobs），如消息队列消费者、表监听器等。

### 启动流程图

```
┌─────────────────────────────────────────────────────────────┐
│                    main() 函数启动                           │
└────────────────────┬────────────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────────┐
│  1. 解析命令行参数 (flagconf)                                │
│     - 默认配置路径: "../../configs"                          │
└────────────────────┬────────────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────────┐
│  2. 加载配置 (config.LoadBootstrapWithViper)                 │
│     - 使用 Viper 包装实现，支持配置中心                      │
│     - 加载 bootstrap 配置（Data, Service）                  │
└────────────────────┬────────────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────────┐
│  3. 初始化 Logger (logger.NewZapLoggerWithConfig)            │
│     - 从配置读取日志级别、格式、输出路径                      │
│     - 支持 OpenTelemetry trace 信息自动提取                 │
│     - 默认值: level=info, format=json, output=stdout         │
└────────────────────┬────────────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────────┐
│  4. Wire 依赖注入 (wireApp)                                  │
│     - 创建 DaemonJobSet（包含所有 daemon jobs）              │
│     - 目前 DaemonJobSet 为空（待添加具体 jobs）              │
└────────────────────┬────────────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────────┐
│  5. 创建 Kratos App (newApp)                                 │
│     - 设置应用 ID、名称、版本、Logger                         │
│     - 如果有 daemon jobs，注册生命周期钩子：                  │
│       • BeforeStart: 在独立 goroutine 中启动每个 job         │
│       • BeforeStop: 停止所有 jobs                            │
└────────────────────┬────────────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────────┐
│  6. 运行应用 (app.Run())                                     │
│     - 执行 BeforeStart 钩子（启动所有 daemon jobs）          │
│     - 等待停止信号（SIGTERM/SIGINT）                         │
│     - 收到信号后执行 BeforeStop 钩子（停止所有 jobs）       │
│     - 执行 cleanup 函数                                      │
└─────────────────────────────────────────────────────────────┘
```

### 关键代码位置

- **入口**: `cmd/daemon-worker/main.go`
- **应用配置**: `cmd/daemon-worker/app.go`
- **依赖注入**: `cmd/daemon-worker/wire.go`
- **Daemon Jobs 集合**: `cmd/daemon-worker/daemon_set.go`

### 特点

- **常驻运行**：每个 daemon job 在独立的 goroutine 中持续运行
- **优雅停止**：通过 Kratos 生命周期钩子管理启动和停止
- **可扩展**：通过 `DaemonJobSet` 轻松添加新的 daemon jobs

---

## 2. cron-worker

**用途**：运行定时任务（Cron Jobs），按 cron 表达式定期执行任务。

### 启动流程图

```
┌─────────────────────────────────────────────────────────────┐
│                    main() 函数启动                           │
└────────────────────┬────────────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────────┐
│  1. 解析命令行参数 (flagconf)                                │
│     - 默认配置路径: "../../configs"                          │
└────────────────────┬────────────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────────┐
│  2. 加载配置 (config.LoadBootstrapWithViper)                 │
│     - 加载 bootstrap 配置（Data, Service）                  │
└────────────────────┬────────────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────────┐
│  3. 初始化 Logger (logger.NewZapLoggerWithConfig)            │
│     - 从配置读取日志级别、格式、输出路径                      │
│     - 支持 OpenTelemetry trace 信息自动提取                 │
└────────────────────┬────────────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────────┐
│  4. Wire 依赖注入 (wireApp)                                  │
│     - 创建数据库连接 (data.NewDB)                            │
│     - 创建数据层 (data.NewData)                              │
│     - 创建数据访问层 (data.NewUserRepo, etc.)                │
│     - 创建业务层 (biz.NewUserUsecase)                        │
│     - 创建 Cron Manager (cron.NewManager)                   │
│     - 创建 Cron Jobs (jobs.NewSyncUserJob, etc.)             │
└────────────────────┬────────────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────────┐
│  5. 创建 Kratos App (newApp)                                 │
│     - 注册所有 Cron 任务到 Manager                           │
│     - 设置应用 ID、名称、版本、Logger                         │
│     - 注册 BeforeStart 钩子：                                │
│       • 在独立 goroutine 中启动 Cron Manager                 │
│       • Manager.Start() 会阻塞直到 context 取消             │
└────────────────────┬────────────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────────┐
│  6. 运行应用 (app.Run())                                     │
│     - 执行 BeforeStart 钩子（启动 Cron Manager）              │
│     - Cron Manager 开始按 cron 表达式调度任务                │
│     - 等待停止信号（SIGTERM/SIGINT）                         │
│     - 收到信号后停止 Cron Manager                            │
│     - 等待所有运行中的任务完成（最多 30 秒）                 │
│     - 执行 cleanup 函数                                      │
└─────────────────────────────────────────────────────────────┘
```

### 关键代码位置

- **入口**: `cmd/cron-worker/main.go`
- **应用配置**: `cmd/cron-worker/app.go`
- **依赖注入**: `cmd/cron-worker/wire.go`
- **Cron Manager**: `internal/biz/cron/manager.go`
- **Cron Jobs**: `internal/biz/cron/jobs/`

### 特点

- **定时调度**：使用 `robfig/cron` 库，支持秒级精度（6 位表达式）
- **时区支持**：默认使用 `Asia/Shanghai` 时区
- **错误恢复**：使用 cron 的 Recover 链防止 panic
- **优雅停止**：停止时等待所有运行中的任务完成

### Cron 表达式示例

- `0 0 2 * * *` - 每天凌晨 2 点执行
- `0 */5 * * * *` - 每 5 分钟执行一次
- `0 0 0 * * 0` - 每周日凌晨执行

---

## 3. sre (主服务)

**用途**：提供 gRPC 和 HTTP API 服务，处理业务请求。

### 启动流程图

```
┌─────────────────────────────────────────────────────────────┐
│                    main() 函数启动                           │
└────────────────────┬────────────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────────┐
│  1. 解析命令行参数 (flagconf)                                │
│     - 默认配置路径: "../../configs"                          │
└────────────────────┬────────────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────────┐
│  2. 加载配置 (config.LoadBootstrapWithViper)                 │
│     - 加载 bootstrap 配置（Server, Data, Registry, Service）│
└────────────────────┬────────────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────────┐
│  3. 初始化 Logger (logger.NewZapLoggerWithConfig)            │
│     - 从配置读取日志级别、格式、输出路径                      │
│     - 支持 OpenTelemetry trace 信息自动提取                 │
└────────────────────┬────────────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────────┐
│  4. Wire 依赖注入 (wireApp)                                  │
│     ├─ 基础设施层                                             │
│     │  • data.NewDB (数据库连接)                             │
│     │  • data.NewData (数据层容器)                            │
│     │  • registry.NewRegistry (服务注册中心)                 │
│     ├─ 数据访问层                                             │
│     │  • data.NewUserRepo                                     │
│     │  • data.NewDingTalkClient                              │
│     │  • data.NewExternalUserService                         │
│     ├─ 业务逻辑层                                             │
│     │  • biz.NewUserUsecase                                  │
│     │  • biz.NewDingTalkEventUsecase                         │
│     ├─ 服务层                                                 │
│     │  • service.NewUserService                              │
│     │  • service.NewDingTalkEventService                     │
│     └─ 服务器层                                               │
│       • server.NewGRPCServer                                 │
│       • server.NewHTTPServer                                 │
└────────────────────┬────────────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────────┐
│  5. 创建 Kratos App (newApp)                                 │
│     - 设置应用 ID、名称、版本、Logger                         │
│     - 注册 gRPC 和 HTTP 服务器                                │
│     - 如果配置了注册中心，注册服务到注册中心                  │
│     - 注册 DingTalkEventService 生命周期钩子：                │
│       • BeforeStart: 启动事件服务                             │
│       • BeforeStop: 停止事件服务                              │
└────────────────────┬────────────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────────┐
│  6. 运行应用 (app.Run())                                     │
│     - 执行 BeforeStart 钩子（启动 DingTalkEventService）      │
│     - 启动 gRPC 服务器                                        │
│     - 启动 HTTP 服务器                                       │
│     - 如果配置了注册中心，注册服务                            │
│     - 等待停止信号（SIGTERM/SIGINT）                         │
│     - 收到信号后：                                            │
│       • 从注册中心注销服务                                    │
│       • 停止 HTTP 服务器                                      │
│       • 停止 gRPC 服务器                                      │
│       • 执行 BeforeStop 钩子（停止 DingTalkEventService）    │
│     - 执行 cleanup 函数                                      │
└─────────────────────────────────────────────────────────────┘
```

### 关键代码位置

- **入口**: `cmd/sre/main.go`
- **依赖注入**: `cmd/sre/wire.go`
- **服务层**: `internal/service/`
- **服务器**: `internal/server/`

### 特点

- **多协议支持**：同时提供 gRPC 和 HTTP 服务
- **服务注册**：支持注册到服务注册中心（如 Consul、Etcd）
- **事件处理**：集成钉钉事件服务，处理钉钉回调事件
- **优雅停止**：按顺序停止各个组件

---

## 4. sre-client (命令行客户端)

**用途**：命令行工具，用于方便地调用业务层的 usecase，执行管理操作。

### 启动流程图

```
┌─────────────────────────────────────────────────────────────┐
│                    main() 函数启动                           │
└────────────────────┬────────────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────────┐
│  1. 创建 Cobra 根命令                                        │
│     - 使用: "sre-client"                                     │
│     - 设置 PersistentPreRunE 钩子（加载配置和初始化依赖）     │
│     - 设置 PersistentPostRun 钩子（清理资源）                 │
└────────────────────┬────────────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────────┐
│  2. 添加子命令                                                │
│     - user (用户管理命令)                                     │
│       • create - 创建用户                                    │
│       • get - 获取用户信息                                   │
│       • update - 更新用户信息                                 │
│       • delete - 删除用户                                   │
│       • list - 列出用户                                      │
└────────────────────┬────────────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────────┐
│  3. 执行命令 (rootCmd.Execute())                             │
│     - 解析命令行参数                                          │
│     - 执行 PersistentPreRunE 钩子：                           │
│       ├─ 加载配置 (config.LoadBootstrapWithViper)            │
│       ├─ 初始化 Logger                                       │
│       ├─ Wire 依赖注入 (wireApp)                             │
│       │  • 创建数据库连接                                     │
│       │  • 创建数据访问层                                     │
│       │  • 创建业务层 (UserUsecase)                          │
│       └─ 创建 AppContext（保存依赖）                          │
└────────────────────┬────────────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────────┐
│  4. 执行具体命令 (如 user create/get/update/delete/list)      │
│     - 从 AppContext 获取 UserUsecase                         │
│     - 调用业务层方法执行操作                                  │
│     - 输出结果到控制台                                        │
└────────────────────┬────────────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────────┐
│  5. 执行 PersistentPostRun 钩子                              │
│     - 执行 cleanup 函数（关闭数据库连接等）                   │
└─────────────────────────────────────────────────────────────┘
```

### 关键代码位置

- **入口**: `cmd/sre-client/main.go`
- **依赖注入**: `cmd/sre-client/wire.go`

### 特点

- **命令行工具**：使用 Cobra 框架构建
- **按需初始化**：只在执行命令时初始化依赖
- **资源管理**：命令执行完成后自动清理资源
- **易于扩展**：可以轻松添加新的子命令

### 使用示例

```bash
# 创建用户
sre-client user create --username alice --email alice@example.com --password secret

# 获取用户信息
sre-client user get 1

# 更新用户信息
sre-client user update 1 --nickname "Alice Smith"

# 删除用户
sre-client user delete 1

# 列出用户
sre-client user list --page 1 --page-size 10 --keyword alice
```

---

## 共同特点

### 1. 配置加载
所有应用都使用 `config.LoadBootstrapWithViper` 加载配置，支持：
- 配置文件（YAML/JSON）
- 配置中心（如 Consul、Etcd）
- 环境变量

### 2. 日志系统
所有应用都使用统一的日志系统：
- 基于 Zap 的高性能日志库
- 支持从 context 中自动提取 OpenTelemetry trace 信息
- 可配置日志级别、格式、输出路径

### 3. 依赖注入
所有应用都使用 Wire 进行依赖注入：
- 编译时依赖注入，性能好
- 类型安全
- 易于维护和测试

### 4. 优雅停止
所有应用都支持优雅停止：
- 监听 SIGTERM/SIGINT 信号
- 通过生命周期钩子管理组件启动和停止
- 确保资源正确释放

### 5. OpenTelemetry 集成
所有应用都集成了 OpenTelemetry：
- 自动追踪请求链路
- 日志自动关联 trace 信息
- 支持分布式追踪

---

## 应用对比

| 应用 | 类型 | 主要功能 | 运行方式 |
|------|------|----------|----------|
| **daemon-worker** | 后台服务 | 运行常驻后台任务 | 持续运行，每个 job 在独立 goroutine 中 |
| **cron-worker** | 定时任务服务 | 按 cron 表达式执行定时任务 | 持续运行，定时调度任务 |
| **sre** | API 服务 | 提供 gRPC/HTTP API | 持续运行，监听端口 |
| **sre-client** | 命令行工具 | 执行管理操作 | 执行命令后退出 |

---

## 相关文档

- [项目架构文档](../architecture/README.md)
- [配置管理文档](../development/config-management.md)
- [依赖注入文档](../development/dependency-injection.md)
- [日志系统文档](../development/logging.md)
- [OpenTelemetry 追踪文档](../development/opentelemetry-tracing-third-party.md)

