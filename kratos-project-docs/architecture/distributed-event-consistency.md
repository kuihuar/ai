## åˆ†å¸ƒå¼äº‹ä»¶ä¸€è‡´æ€§æ¶æ„è®¾è®¡ï¼ˆOutbox + Sagaï¼‰

æœ¬æ–‡æ¡£è¯´æ˜åœ¨å½“å‰ SRE é¡¹ç›®ä¸­ï¼Œå¦‚ä½•åŸºäº **æœ¬åœ°äº‹åŠ¡ + Outbox**ï¼ˆæ–¹æ¡ˆ 1ï¼‰å’Œ **Saga æ¨¡å¼**ï¼ˆæ–¹æ¡ˆ 3ï¼‰å®ç°åˆ†å¸ƒå¼äº‹ä»¶ä¸€è‡´æ€§ã€‚  
ä»¥è®¢å•ä¸šåŠ¡ä¸ºä¾‹ï¼Œæ‰€æœ‰ç¤ºæ„å‡å¯æ¨å¹¿åˆ°å…¶ä»–èšåˆæ ¹ã€‚

---

## æ–¹æ¡ˆå¯¹æ¯”ä¸æ¨è

### æ–¹æ¡ˆ1 vs æ–¹æ¡ˆ3ï¼šä¸æ˜¯äºŒé€‰ä¸€ï¼Œè€Œæ˜¯äº’è¡¥å…³ç³»

**æ ¸å¿ƒç»“è®º**ï¼šæ–¹æ¡ˆ1ï¼ˆOutboxï¼‰å’Œæ–¹æ¡ˆ3ï¼ˆSagaï¼‰è§£å†³çš„æ˜¯ä¸åŒå±‚é¢çš„é—®é¢˜ï¼Œé€šå¸¸**ç»„åˆä½¿ç”¨**ã€‚

| ç»´åº¦ | æ–¹æ¡ˆ1ï¼šOutbox | æ–¹æ¡ˆ3ï¼šSaga |
|------|-------------|------------|
| **è§£å†³çš„é—®é¢˜** | å•ä¸ªæœåŠ¡å†…ï¼šä¸šåŠ¡æ“ä½œ + äº‹ä»¶å‘å¸ƒçš„åŸå­æ€§ | è·¨å¤šä¸ªæœåŠ¡ï¼šåˆ†å¸ƒå¼é•¿äº‹åŠ¡çš„æœ€ç»ˆä¸€è‡´æ€§ |
| **é€‚ç”¨åœºæ™¯** | æ‰€æœ‰éœ€è¦å‘å¸ƒé¢†åŸŸäº‹ä»¶çš„æœåŠ¡ | éœ€è¦è·¨æœåŠ¡ç¼–æ’çš„ä¸šåŠ¡æµç¨‹ï¼ˆå¦‚ï¼šè®¢å•â†’åº“å­˜â†’æ”¯ä»˜ï¼‰ |
| **æŠ€æœ¯å¤æ‚åº¦** | ä½ï¼ˆä¸»è¦æ˜¯è¡¨ç»“æ„ + åå° Jobï¼‰ | ä¸­é«˜ï¼ˆéœ€è¦çŠ¶æ€æœºã€è¡¥å¿é€»è¾‘ã€ç¼–æ’å™¨ï¼‰ |
| **ä¸šåŠ¡ä¾µå…¥æ€§** | ä½ï¼ˆåªéœ€åœ¨ Repo å±‚å¢åŠ  Outbox å†™å…¥ï¼‰ | é«˜ï¼ˆéœ€è¦è®¾è®¡è¡¥å¿æ“ä½œã€Saga çŠ¶æ€ç®¡ç†ï¼‰ |
| **æ€§èƒ½å½±å“** | å‡ ä¹æ— å½±å“ï¼ˆæœ¬åœ°äº‹åŠ¡ï¼Œå¼‚æ­¥æŠ•é€’ï¼‰ | æœ‰ä¸€å®šå½±å“ï¼ˆéœ€è¦å¤šæ¬¡è·¨æœåŠ¡è°ƒç”¨ï¼‰ |
| **å®ç°ä¼˜å…ˆçº§** | **å¿…é¡»å…ˆåš**ï¼ˆåŸºç¡€è®¾æ–½ï¼‰ | æŒ‰éœ€å¼•å…¥ï¼ˆä¸šåŠ¡é©±åŠ¨ï¼‰ |

### æ¨èæ–¹æ¡ˆï¼šå…ˆåš Outboxï¼Œå†æŒ‰éœ€å¼•å…¥ Saga

#### é˜¶æ®µä¸€ï¼šå…ˆå®ç° Outboxï¼ˆæ–¹æ¡ˆ1ï¼‰

**ä¸ºä»€ä¹ˆå…ˆåš Outboxï¼Ÿ**

1. **æ›´åŸºç¡€ã€æ›´é€šç”¨**ï¼šæ‰€æœ‰éœ€è¦å‘å¸ƒäº‹ä»¶çš„æœåŠ¡éƒ½éœ€è¦å®ƒ
2. **å®ç°ç®€å•**ï¼šä¸»è¦æ˜¯è¡¨ç»“æ„ + åå° Jobï¼Œä¸æ¶‰åŠå¤æ‚çš„ä¸šåŠ¡æµç¨‹ç¼–æ’
3. **é£é™©ä½**ï¼šå¯¹ç°æœ‰ä¸šåŠ¡ä»£ç ä¾µå…¥å°ï¼Œå¯ä»¥æ¸è¿›å¼æ”¹é€ 
4. **ç‹¬ç«‹ä»·å€¼**ï¼šå³ä½¿ä¸åš Sagaï¼ŒOutbox æœ¬èº«å°±èƒ½è§£å†³â€œäº‹ä»¶ä¸¢å¤±â€é—®é¢˜

**é€‚ç”¨åœºæ™¯**ï¼š
- âœ… è®¢å•æœåŠ¡åˆ›å»ºè®¢å•åï¼Œéœ€è¦é€šçŸ¥åº“å­˜æœåŠ¡
- âœ… ç”¨æˆ·æœåŠ¡æ›´æ–°ç”¨æˆ·ä¿¡æ¯åï¼Œéœ€è¦åŒæ­¥åˆ°æœç´¢ç´¢å¼•
- âœ… æ”¯ä»˜æœåŠ¡å®Œæˆæ”¯ä»˜åï¼Œéœ€è¦è§¦å‘è®¢å•çŠ¶æ€æ›´æ–°
- âœ… **æ‰€æœ‰â€œä¸šåŠ¡æ“ä½œ + äº‹ä»¶å‘å¸ƒâ€éœ€è¦åŸå­æ€§çš„åœºæ™¯**

#### é˜¶æ®µäºŒï¼šæŒ‰éœ€å¼•å…¥ Sagaï¼ˆæ–¹æ¡ˆ3ï¼‰

**ä»€ä¹ˆæ—¶å€™éœ€è¦ Sagaï¼Ÿ**

å½“ä½ çš„ä¸šåŠ¡æµç¨‹éœ€è¦**è·¨å¤šä¸ªæœåŠ¡**ï¼Œä¸”éœ€è¦ä¿è¯â€œè¦ä¹ˆå…¨éƒ¨æˆåŠŸï¼Œè¦ä¹ˆå…¨éƒ¨å›æ»šâ€æ—¶ï¼š

- âœ… åˆ›å»ºè®¢å• â†’ é¢„å åº“å­˜ â†’ æ‰£å‡ä½™é¢ â†’ ç¡®è®¤è®¢å•ï¼ˆéœ€è¦è¡¥å¿ï¼šå–æ¶ˆè®¢å•ã€é‡Šæ”¾åº“å­˜ã€é€€æ¬¾ï¼‰
- âœ… ç”¨æˆ·æ³¨å†Œ â†’ åˆ›å»ºè´¦æˆ· â†’ å‘é€æ¬¢è¿é‚®ä»¶ï¼ˆéœ€è¦è¡¥å¿ï¼šåˆ é™¤è´¦æˆ·ã€å–æ¶ˆé‚®ä»¶ï¼‰
- âŒ å•ä¸ªæœåŠ¡å†…çš„æ“ä½œï¼ˆä¸éœ€è¦ Sagaï¼Œç”¨ Outbox å°±å¤Ÿäº†ï¼‰

**Saga çš„å®ç°ä¾èµ– Outbox**ï¼š
- æ¯ä¸ªå‚ä¸ Saga çš„æœåŠ¡å†…éƒ¨ï¼Œä¾ç„¶ç”¨ Outbox ä¿è¯äº‹ä»¶å¯é å‘å¸ƒ
- Saga Orchestrator è´Ÿè´£ç¼–æ’è·¨æœåŠ¡çš„æµç¨‹ï¼Œå¤±è´¥æ—¶è§¦å‘è¡¥å¿

### ç»„åˆä½¿ç”¨ç¤ºä¾‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Saga Orchestrator (ç¼–æ’è·¨æœåŠ¡æµç¨‹)                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                    â”‚                    â”‚
         v                    v                    v
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Order Serviceâ”‚    â”‚Inventory Svc â”‚    â”‚Payment Svc   â”‚
â”‚              â”‚    â”‚              â”‚    â”‚              â”‚
â”‚ [Outbox]     â”‚    â”‚ [Outbox]     â”‚    â”‚ [Outbox]     â”‚
â”‚ - æœ¬åœ°äº‹åŠ¡   â”‚    â”‚ - æœ¬åœ°äº‹åŠ¡   â”‚    â”‚ - æœ¬åœ°äº‹åŠ¡   â”‚
â”‚ - äº‹ä»¶å‘å¸ƒ   â”‚    â”‚ - äº‹ä»¶å‘å¸ƒ   â”‚    â”‚ - äº‹ä»¶å‘å¸ƒ   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### åœ¨å½“å‰é¡¹ç›®ä¸­çš„å®æ–½å»ºè®®

1. **ç¬¬ä¸€æ­¥ï¼ˆå¿…é¡»ï¼‰**ï¼šå®ç° Outbox åŸºç¡€è®¾æ–½
   - åœ¨ `internal/data` ä¸­å®ç° `OutboxRepo`
   - åœ¨ `cmd/cron-worker` ä¸­å®ç°äº‹ä»¶æŠ•é€’ Job
   - æ”¹é€ ç°æœ‰ `OrderRepo`ï¼Œå¢åŠ  `SaveWithEvent` æ–¹æ³•

2. **ç¬¬äºŒæ­¥ï¼ˆæŒ‰éœ€ï¼‰**ï¼šå¼•å…¥ Saga ç¼–æ’
   - å½“å‡ºç°è·¨æœåŠ¡é•¿äº‹åŠ¡éœ€æ±‚æ—¶ï¼Œå†å®ç° `OrderSagaUseCase`
   - å¯ä»¥å…ˆä»ç®€å•çš„â€œè®¢å•åˆ›å»ºæµç¨‹â€å¼€å§‹éªŒè¯

3. **æ¸è¿›å¼æ”¹é€ **ï¼š
   - æ–°åŠŸèƒ½ç›´æ¥ä½¿ç”¨ Outbox
   - è€åŠŸèƒ½é€æ­¥è¿ç§»ï¼ˆä¸å½±å“ç°æœ‰ä¸šåŠ¡ï¼‰

---

## 1. æ–¹æ¡ˆä¸€ï¼šæœ¬åœ°äº‹åŠ¡ + Outbox æ¶æ„

### 1.1 åˆ†å±‚ä¸ç»„ä»¶å…³ç³»

é€»è¾‘åˆ†å±‚ä¸å½“å‰é¡¹ç›®ä¿æŒä¸€è‡´ï¼š

- **`internal/service`**ï¼šæ¥æ”¶ gRPC/HTTP è¯·æ±‚ï¼Œåšå…¥å‚æ ¡éªŒã€è°ƒç”¨é¢†åŸŸæœåŠ¡ã€‚
- **`internal/biz`**ï¼šé¢†åŸŸæ¨¡å‹ä¸ä¸šåŠ¡ç”¨ä¾‹ï¼Œå®šä¹‰ `Order`ã€`DomainEvent`ã€`OutboxEvent` ç­‰æŠ½è±¡ã€‚
- **`internal/data`**ï¼š  
  - å®ç° `OrderRepo` ç­‰èšåˆæ ¹ä»“å‚¨ï¼›  
  - å®ç° `OutboxRepo`ï¼Œåœ¨åŒä¸€ä¸ªæœ¬åœ°äº‹åŠ¡é‡Œå†™å…¥ä¸šåŠ¡è¡¨å’Œ Outbox è¡¨ï¼›  
  - ä½¿ç”¨ `ent.Client` ç®¡ç†æ•°æ®åº“äº‹åŠ¡ã€‚
- **`cmd/cron-worker` / `cmd/daemon-worker`**ï¼š  
  - é€šè¿‡ `internal/app/worker` ç­‰å°è£…ï¼Œå‘¨æœŸæ€§æ‰«æ Outbox è¡¨ï¼Œå‘ MQ/Kafka å¯é æŠ•é€’äº‹ä»¶ï¼Œå¹¶æ›´æ–°çŠ¶æ€ã€‚
- **å¤–éƒ¨ç»„ä»¶**ï¼š  
  - **æ•°æ®åº“**ï¼šè®¢å•è¡¨ã€ç”¨æˆ·è¡¨ã€Outbox è¡¨ç­‰ï¼›  
  - **MQ / äº‹ä»¶æ€»çº¿**ï¼šKafka/RabbitMQ ç­‰ï¼›  
  - **ä¸‹æ¸¸æœåŠ¡**ï¼šæ¶ˆè´¹äº‹ä»¶ï¼Œåšå¹‚ç­‰å¤„ç†ã€‚

æ–‡å­—ç‰ˆæ¶æ„å›¾ï¼š

```text
[Client / API Gateway]
          |
          v
   internal/service
          |
          v
      internal/biz
          |
          v
      internal/data
   +----------------------+
   | OrderRepo            |
   | OutboxRepo           |
   +----------------------+
          |
          v  (æœ¬åœ°äº‹åŠ¡)
   +----------------------+
   |   DB                 |
   | - orders             |
   | - outbox_events      |
   +----------------------+

   [cron-worker / daemon-worker]
          |
          v
   [MQ / Event Bus] ---> [ä¸‹æ¸¸æœåŠ¡ (order-consumer ç­‰)]
```

### 1.2 æ—¶åºæµç¨‹ï¼ˆåˆ›å»ºè®¢å•ç¤ºä¾‹ï¼‰

ä»¥â€œåˆ›å»ºè®¢å•å¹¶å‘å¸ƒè®¢å•åˆ›å»ºäº‹ä»¶â€ä¸ºä¾‹ï¼š

```text
Client
  |
  | 1. CreateOrder è¯·æ±‚
  v
internal/service (OrderService)
  |
  | 2. è°ƒç”¨ biz.OrderUseCase.CreateOrder(ctx, cmd)
  v
internal/biz (OrderUseCase)
  |
  | 3. æ„é€  Order èšåˆæ ¹ + DomainEvent(OrderCreated)
  | 4. è°ƒç”¨ repo.SaveWithEvent(ctx, order, event)
  v
internal/data (OrderRepo + OutboxRepo)
  |
  | 5. å¼€å¯æœ¬åœ°äº‹åŠ¡ (ent.Tx)
  |    - INSERT orders
  |    - INSERT outbox_events (çŠ¶æ€ = PENDING)
  | 6. æäº¤äº‹åŠ¡
  v
DB (orders + outbox_events)
  |
  | (æ­¤æ—¶ä¸šåŠ¡æ•°æ®å’Œäº‹ä»¶éƒ½å·²æŒä¹…åŒ–)
  +-------------------------------+
                                  |
                                  v
                    cron-worker / daemon-worker (äº‹ä»¶ä¸­è½¬ Job)
                                  |
                                  | 7. å‘¨æœŸæ€§æ‰«æ outbox_events
                                  |    WHERE status = PENDING
                                  | 8. å‘é€äº‹ä»¶åˆ° MQ (å¸¦ä¸Š EventID åšå¹‚ç­‰)
                                  | 9. æ›´æ–°çŠ¶æ€ä¸º SENT æˆ– FAILED
                                  v
                                MQ
                                  |
                                  | 10. ä¸‹æ¸¸æœåŠ¡æ¶ˆè´¹äº‹ä»¶ï¼Œå¹‚ç­‰æ›´æ–°è‡ªå·±çš„çŠ¶æ€
                                  v
                               ä¸‹æ¸¸æœåŠ¡
```

### 1.3 Outbox è¡¨ä¸é¢†åŸŸæŠ½è±¡ï¼ˆè®¾è®¡è¦ç‚¹ï¼‰

- **è¡¨ç»“æ„å»ºè®®ï¼ˆé€»è¾‘å­—æ®µï¼‰**ï¼š
  - `id`ï¼šè‡ªå¢ä¸»é”®ï¼›
  - `event_id`ï¼šä¸šåŠ¡äº‹ä»¶ IDï¼ˆç”¨äºå¹‚ç­‰ã€å»é‡ï¼‰ï¼›
  - `aggregate_type`ï¼šèšåˆç±»å‹ï¼Œå¦‚ `order`ï¼›
  - `aggregate_id`ï¼šèšåˆ IDï¼Œå¦‚è®¢å• IDï¼›
  - `event_type`ï¼šäº‹ä»¶ç±»å‹ï¼Œå¦‚ `OrderCreated`ï¼›
  - `payload`ï¼šåºåˆ—åŒ–åçš„äº‹ä»¶ä½“ï¼ˆJSON/Protobufï¼‰ï¼›
  - `status`ï¼š`PENDING` / `SENT` / `FAILED`ï¼›
  - `retry_count`ï¼šé‡è¯•æ¬¡æ•°ï¼›
  - `next_retry_at`ï¼šä¸‹æ¬¡é‡è¯•æ—¶é—´ï¼Œç”¨äºé€€é¿ï¼›
  - `created_at` / `updated_at`ã€‚

- **é¢†åŸŸå±‚æŠ½è±¡ï¼ˆç¤ºæ„ï¼‰**ï¼š
  - `DomainEvent`ï¼šé¢†åŸŸäº‹ä»¶æ¥å£ï¼Œå±è”½å…·ä½“åºåˆ—åŒ–æ ¼å¼ï¼›
  - `OutboxEvent`ï¼šé¢†åŸŸå±‚å¯¹ Outbox è¡Œçš„å»ºæ¨¡ï¼›
  - `OutboxRepo`ï¼šå®šä¹‰ `SaveEvent(ctx, *OutboxEvent)`ã€`ListPending(ctx, limit)` ç­‰æ–¹æ³•ï¼›
  - `EventPublisher`ï¼šworker ä¾§ä½¿ç”¨ï¼Œç”¨äºå°† `OutboxEvent` æŠ•é€’åˆ° MQã€‚

è¿™äº›æ¥å£çš„å…·ä½“ Go å®ç°å¯æ”¾åœ¨ `internal/data` ä¸­ï¼Œé¢†åŸŸæ¥å£æ”¾åœ¨ `internal/biz` ä¸­ã€‚

---

## 2. æ–¹æ¡ˆä¸‰ï¼šSaga æ¨¡å¼æ¶æ„ï¼ˆåŸºäº Outbox çš„é•¿äº‹åŠ¡ï¼‰

Saga æ¨¡å¼ä¾§é‡â€œè·¨å¤šä¸ªæœåŠ¡çš„é•¿äº‹åŠ¡â€ï¼Œæœ¬é¡¹ç›®ä¸­å¯ä»¥å¤ç”¨ Outbox æœºåˆ¶ï¼Œç”¨ç¼–æ’å™¨ï¼ˆOrchestratorï¼‰æ¥è°ƒç”¨å„ä¸ªæœåŠ¡çš„æœ¬åœ°äº‹åŠ¡ã€‚

### 2.1 ç»„ä»¶è§†å›¾

ä»¥å…¸å‹çš„è®¢å•åœºæ™¯ä¸ºä¾‹ï¼ŒSaga æµç¨‹ï¼š

`åˆ›å»ºè®¢å• -> é¢„å åº“å­˜ -> å†»ç»“ä½™é¢ -> ç¡®è®¤è®¢å•`ï¼Œå¤±è´¥æ—¶æ‰§è¡Œç›¸åçš„è¡¥å¿æ­¥éª¤ï¼š

`å–æ¶ˆè®¢å• -> é‡Šæ”¾åº“å­˜ -> è§£å†»ä½™é¢`ã€‚

æ¶‰åŠç»„ä»¶ï¼š

- **Saga Orchestrator**ï¼š  
  - å¯ä»¥ï¼š  
    - ä½œä¸ºè®¢å•æœåŠ¡ä¸­çš„ä¸€ä¸ªç”¨ä¾‹ï¼ˆå¦‚ `OrderSagaUseCase`ï¼‰ï¼›  
    - æˆ–è€…å•ç‹¬æ”¾åœ¨ä¸€ä¸ª `internal/biz/saga` å­åŒ…ä¸­ï¼Œæœªæ¥å¯æŠ½è±¡ä¸ºå…¬å…±ç¼–æ’æ¨¡å—ã€‚
- **å‚ä¸æœåŠ¡**ï¼š
  - Order Serviceï¼ˆæœ¬é¡¹ç›®å·²æœ‰ï¼‰ï¼›
  - Inventory Serviceï¼ˆå‡è®¾æœªæ¥æ‰©å±•ï¼‰ï¼›
  - Payment Serviceï¼ˆå‡è®¾æœªæ¥æ‰©å±•ï¼‰ã€‚
- **å­˜å‚¨ä¸äº‹ä»¶**ï¼š
  - å„æœåŠ¡å†…éƒ¨ï¼šä¾ç„¶ä½¿ç”¨ â€œæœ¬åœ°äº‹åŠ¡ + Outboxâ€ ä¿è¯æœ¬æœåŠ¡å†…ä¸€è‡´æ€§ï¼›  
  - è·¨æœåŠ¡ç¼–æ’ï¼šSaga Orchestrator å¯ä»¥é‡‡ç”¨ï¼š
    - åŒæ­¥ gRPC è°ƒç”¨ + çŠ¶æ€æœºæŒä¹…åŒ–ï¼›æˆ–
    - åŸºäºäº‹ä»¶ï¼ˆMQï¼‰çš„å¼‚æ­¥ç¼–æ’ã€‚

æ–‡å­—ç‰ˆç»„ä»¶æ‹“æ‰‘ï¼š

```text
                +-----------------------+
                |  Saga Orchestrator   |
                | (OrderSagaUseCase)   |
                +-----------+-----------+
                            |
       (gRPC / äº‹ä»¶å‘½ä»¤)    |
                            v
   +------------+    +-------------+    +-------------+
   | Order      |    | Inventory   |    | Payment     |
   | Service    |    | Service     |    | Service     |
   +-----+------+    +------+------ +   +------+------+
         |                  |                 |
         |  Outbox (DB)     | Outbox (DB)     | Outbox (DB)
         v                  v                 v
   +-----------+      +-----------+     +-----------+
   | orders +  |      | stocks +  |     | accounts +|
   | outbox    |      | outbox    |     | outbox    |
   +-----------+      +-----------+     +-----------+
         \                  |                 /
          \                 |                /
           \                v               /
              ------- [ MQ / Event Bus ] ------
```

### 2.2 Saga æˆåŠŸè·¯å¾„æ—¶åºï¼ˆç®€åŒ–ç‰ˆï¼‰

```text
Client
  |
  | 1. è¯·æ±‚åˆ›å»ºå¸¦æ”¯ä»˜çš„è®¢å•
  v
Saga Orchestrator (OrderSagaUseCase)
  |
  | 2. Step1: è°ƒç”¨ Order Service: CreatePendingOrder
  v
Order Service
  |
  |-- æœ¬åœ°äº‹åŠ¡ + Outbox:
  |   - åˆ›å»º pending çŠ¶æ€è®¢å•
  |   - å†™å…¥ Outbox: OrderCreated
  v
DB (orders + outbox)
  |
Saga Orchestrator
  |
  | 3. Step2: è°ƒç”¨ Inventory Service: ReserveStock
  v
Inventory Service
  |
  |-- æœ¬åœ°äº‹åŠ¡ + Outbox:
  |   - é¢„å åº“å­˜
  |   - å†™å…¥ Outbox: StockReserved
  v
DB (stocks + outbox)
  |
Saga Orchestrator
  |
  | 4. Step3: è°ƒç”¨ Payment Service: FreezeBalance
  v
Payment Service
  |
  |-- æœ¬åœ°äº‹åŠ¡ + Outbox:
  |   - å†»ç»“ä½™é¢
  |   - å†™å…¥ Outbox: BalanceFrozen
  v
DB (accounts + outbox)
  |
Saga Orchestrator
  |
  | 5. æ‰€æœ‰å‰ç½®æ­¥éª¤æˆåŠŸ:
  |    - ConfirmOrder
  |    - ConfirmStock
  |    - ConfirmPayment
  v
å„æœåŠ¡æ›´æ–°æœ€ç»ˆçŠ¶æ€ï¼ˆè®¢å•ç¡®è®¤ã€åº“å­˜æ‰£å‡ã€ä½™é¢æ‰£å‡ï¼‰
```

### 2.3 Saga å¤±è´¥ä¸è¡¥å¿æ—¶åºï¼ˆç¤ºä¾‹ï¼šæ”¯ä»˜å¤±è´¥ï¼‰

```text
ï¼ˆå‰ç½®æ­¥éª¤ï¼šè®¢å•åˆ›å»º + é¢„å åº“å­˜æˆåŠŸï¼‰

Payment Service
  |
  | è¿”å›å¤±è´¥ (ä½™é¢ä¸è¶³ / é£æ§æ‹’ç»)
  v
Saga Orchestrator
  |
  | 1. è®°å½• Saga å®ä¾‹çŠ¶æ€ä¸º FAILED
  |
  | 2. è§¦å‘è¡¥å¿ï¼š
  |    - è°ƒç”¨ Inventory Service: ReleaseStock
  |    - è°ƒç”¨ Order Service: CancelOrder
  v
Inventory Service / Order Service
  |
  |-- å„è‡ªä½¿ç”¨æœ¬åœ°äº‹åŠ¡ + Outbox:
  |   - æ›´æ–°ä¸šåŠ¡çŠ¶æ€ (é‡Šæ”¾åº“å­˜ / è®¢å•å–æ¶ˆ)
  |   - å†™å…¥ Outbox: StockReleased / OrderCanceled
  v
DB (stocks + orders + outbox)
  |
Saga Orchestrator
  |
  | 3. ç­‰å¾…æ‰€æœ‰è¡¥å¿æˆåŠŸ
  | 4. å°† Saga å®ä¾‹æ ‡è®°ä¸º COMPLETED (æœ€ç»ˆä¸šåŠ¡ç»“æœä¸ºâ€œå¤±è´¥ä½†å·²å›æ»šâ€)
  v
Client
  |
  | 5. å‰ç«¯æŸ¥è¯¢è®¢å•çŠ¶æ€ï¼Œçœ‹åˆ°è®¢å•å·²å–æ¶ˆ
  v
```

### 2.4 åœ¨æœ¬é¡¹ç›®ä¸­çš„è½åœ°å»ºè®®

- **é¢†åŸŸå±‚ï¼ˆ`internal/biz`ï¼‰**ï¼š
  - å®šä¹‰ `DomainEvent`ã€`OutboxEvent`ã€`OutboxRepo` ç­‰æ¥å£ï¼›
  - ä¸ºè®¢å•åœºæ™¯å®šä¹‰ `OrderSagaUseCase`ï¼Œå†…éƒ¨ç»´æŠ¤ Saga çŠ¶æ€æœºï¼ˆå¯å…ˆç”¨å†…å­˜/æ•°æ®åº“ç®€å•å®ç°ï¼‰ã€‚

- **æ•°æ®å±‚ï¼ˆ`internal/data`ï¼‰**ï¼š
  - ä½¿ç”¨ ent schema å®šä¹‰ `outbox_events` è¡¨ï¼›
  - å®ç° `OutboxRepo` æ¥å£ï¼ˆCRUD + æ‰¹é‡æŸ¥è¯¢ Pending äº‹ä»¶ï¼‰ï¼›
  - åœ¨ `OrderRepo` ç­‰èšåˆæ ¹ä»“å‚¨ä¸­å¢åŠ å¸¦äº‹ä»¶çš„ä¿å­˜æ–¹æ³•ï¼ˆå¦‚ `SaveWithEvent`ï¼‰ï¼Œé€šè¿‡æœ¬åœ°äº‹åŠ¡å†™å…¥è®¢å•å’Œ Outboxã€‚

- **å·¥ä½œè¿›ç¨‹ï¼ˆ`cmd/cron-worker` / `cmd/daemon-worker`ï¼‰**ï¼š
  - å¢åŠ ä¸€ä¸ª Jobï¼šå®šæ—¶æ‰«æ Outboxï¼Œå‘é€åˆ° MQï¼Œå¹¶æ ¹æ®ç»“æœæ›´æ–°çŠ¶æ€ï¼ˆæ”¯æŒé‡è¯•ä¸é€€é¿ï¼‰ã€‚

æœªæ¥å¦‚éœ€æ›´ç»†ç²’åº¦çš„ Saga ç®¡ç†ï¼ˆå¦‚å¯è§†åŒ–/é‡æ”¾ï¼‰ï¼Œå¯ä»¥åœ¨ `docs/development` ä¸‹å¢åŠ ä¸“é—¨çš„ Saga è®¾è®¡æ–‡æ¡£ï¼Œå¹¶æ‰©å±•å¯¹åº”çš„è¡¨ç»“æ„ä¸ API å®šä¹‰ã€‚

---

## 3. å®ç°çŠ¶æ€

### å·²å®Œæˆï¼ˆæ–¹æ¡ˆ 1ï¼šOutboxï¼‰

âœ… **æ•°æ®å±‚ Schema**
- `internal/data/ent/schema/outbox_event.go`ï¼šOutbox è¡¨çš„ ent schema
- åŒ…å«å­—æ®µï¼š`event_id`ã€`aggregate_type`ã€`aggregate_id`ã€`event_type`ã€`payload`ã€`status`ã€`retry_count`ã€`next_retry_at` ç­‰

âœ… **é¢†åŸŸå±‚æ¥å£**
- `internal/biz/event_outbox.go`ï¼šå®šä¹‰ `DomainEvent`ã€`OutboxEvent`ã€`OutboxRepo` æ¥å£
- `internal/biz/order_event.go`ï¼šå®ç° `OrderCreatedEvent`ï¼ˆè®¢å•åˆ›å»ºäº‹ä»¶ï¼‰

âœ… **æ•°æ®å±‚å®ç°**
- `internal/data/outbox_repo.go`ï¼šå®ç° `OutboxRepo`ï¼ˆåŸºäº ent Clientï¼‰
- `internal/data/repo_order.go`ï¼šå®ç° `SaveWithEvent` æ–¹æ³•ï¼ˆäº‹åŠ¡ä¸­åŒæ—¶ä¿å­˜è®¢å•å’Œäº‹ä»¶ï¼‰

âœ… **å®šæ—¶ä»»åŠ¡**
- `internal/biz/cron/jobs/outbox_dispatcher.go`ï¼šOutbox äº‹ä»¶åˆ†å‘ Job
- æ¯ 10 ç§’æ‰«æä¸€æ¬¡ï¼Œå¤„ç† `PENDING` æˆ– `FAILED` çŠ¶æ€çš„äº‹ä»¶
- å·²æ³¨å†Œåˆ° `cron-worker` åº”ç”¨

âœ… **ä¸šåŠ¡é›†æˆ**
- `internal/biz/order.go`ï¼š`CreateOrder` æ–¹æ³•å·²é›†æˆ Outbox
- è®¢å•åˆ›å»ºæ—¶è‡ªåŠ¨å†™å…¥ `OrderCreatedEvent` åˆ° Outbox è¡¨

### å¾…å®ç°

â³ **MQ é›†æˆ**
- å½“å‰ `OutboxDispatchJob` åªæ˜¯æ‰“å°æ—¥å¿—å¹¶æ ‡è®°ä¸ºå·²å‘é€
- éœ€è¦é›†æˆ Kafka/RabbitMQ ç­‰æ¶ˆæ¯ä¸­é—´ä»¶ï¼ŒçœŸæ­£å‘é€äº‹ä»¶åˆ° MQ

â³ **æ›´å¤šäº‹ä»¶ç±»å‹**
- è®¢å•æ”¯ä»˜äº‹ä»¶ï¼ˆ`OrderPaidEvent`ï¼‰
- è®¢å•å–æ¶ˆäº‹ä»¶ï¼ˆ`OrderCancelledEvent`ï¼‰
- å…¶ä»–ä¸šåŠ¡äº‹ä»¶

â³ **Saga æ¨¡å¼ï¼ˆæ–¹æ¡ˆ 3ï¼‰**
- Saga Orchestrator å®ç°
- è·¨æœåŠ¡è¡¥å¿é€»è¾‘
- Saga çŠ¶æ€ç®¡ç†

### æµ‹è¯•éªŒè¯

ğŸ“‹ **æµ‹è¯•æŒ‡å—**
- è¯¦è§ï¼š[Outbox æ¨¡å¼ç«¯åˆ°ç«¯æµ‹è¯•æŒ‡å—](../development/outbox-testing-guide.md)

### å¿«é€Ÿå¼€å§‹

1. **ç”Ÿæˆ ent ä»£ç **ï¼š
   ```bash
   make ent-generate
   ```

2. **å¯åŠ¨ cron-worker**ï¼š
   ```bash
   ./bin/cron-worker -conf ./configs/config.yaml
   ```

3. **åˆ›å»ºè®¢å•**ï¼ˆé€šè¿‡ API æˆ–ä»£ç ï¼‰ï¼Œè§‚å¯Ÿï¼š
   - æ•°æ®åº“ `outbox_events` è¡¨ä¸­æ˜¯å¦æœ‰æ–°è®°å½•
   - cron-worker æ—¥å¿—ä¸­æ˜¯å¦æ˜¾ç¤ºäº‹ä»¶å¤„ç†

4. **éªŒè¯æµç¨‹**ï¼šå‚è€ƒ [æµ‹è¯•æŒ‡å—](../development/outbox-testing-guide.md)


