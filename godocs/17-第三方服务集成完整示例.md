# 第三方服务集成完整示例

## 已实现的第三方服务

### 1. 支付宝集成
- ✅ Client层实现
- ✅ 支付功能
- ✅ 查询功能
- ✅ 配置管理

### 2. 钉钉集成
- ✅ Client层实现
- ✅ 发送消息功能
- ✅ Token缓存机制
- ✅ 配置管理

## 目录结构

```
internal/
  ├── client/              ← 第三方服务客户端层
  │   ├── alipay/
  │   │   ├── client.go   ← 客户端实现
  │   │   ├── types.go    ← 类型定义
  │   │   ├── factory.go  ← 工厂函数
  │   │   └── errors.go   ← 错误定义
  │   └── dingtalk/
  │       ├── client.go
  │       ├── types.go
  │       ├── factory.go
  │       └── errors.go
  ├── service/
  │   ├── payment.go      ← 支付服务（调用alipay client）
  │   └── notification.go ← 通知服务（调用dingtalk client）
  └── controller/
```

## 完整调用链

### 支付宝支付流程

```
HTTP请求: POST /payment
  ↓
Controller层
  - 接收请求参数
  - 调用 service.Payment.CreatePayment()
  ↓
Service层
  - 业务逻辑检查
  - 调用 alipay.GetClient().Pay()
  ↓
Client层 (alipay)
  - 构建请求参数
  - 签名
  - 调用支付宝API
  - 验证签名
  - 返回结果
  ↓
支付宝服务器
  - 处理支付请求
  - 返回支付链接
  ↓
返回支付链接给客户端
```

### 钉钉消息流程

```
HTTP请求: POST /notification/dingtalk
  ↓
Controller层
  - 接收请求参数
  - 调用 service.Notification.SendDingTalkMessage()
  ↓
Service层
  - 业务逻辑检查
  - 调用 dingtalk.GetClient().SendTextMessage()
  ↓
Client层 (dingtalk)
  - 获取access_token（带缓存）
  - 构建请求
  - 调用钉钉API
  - 返回结果
  ↓
钉钉服务器
  - 处理消息请求
  - 发送消息
  ↓
返回成功响应
```

## 使用示例

### 支付宝支付

```go
// Service层调用
payUrl, err := service.Payment.CreatePayment(ctx, "order_123", "测试订单", 100.00)
if err != nil {
    // 处理错误
}
// payUrl 是支付链接，可以返回给前端
```

### 钉钉消息

```go
// Service层调用
err := service.Notification.SendDingTalkMessage(
    ctx,
    123456,                    // agentId
    []string{"user1", "user2"}, // userIds
    "这是一条测试消息",
)
if err != nil {
    // 处理错误
}
```

## 配置说明

在 `manifest/config/config.yaml` 中配置：

```yaml
thirdparty:
  alipay:
    appId: "your_app_id"
    appPrivateKey: "your_private_key"
    alipayPublicKey: "alipay_public_key"
    gateway: "https://openapi.alipay.com/gateway.do"
    timeout: "30s"
  dingtalk:
    appKey: "your_app_key"
    appSecret: "your_app_secret"
    gateway: "https://oapi.dingtalk.com"
    timeout: "30s"
```

## 初始化

在 `internal/cmd/cmd.go` 中自动初始化：

```go
// 初始化第三方服务客户端
if err = alipay.Init(); err != nil {
    return fmt.Errorf("初始化支付宝客户端失败: %w", err)
}

if err = dingtalk.Init(); err != nil {
    return fmt.Errorf("初始化钉钉客户端失败: %w", err)
}
```

## 扩展其他第三方服务

### 添加微信支付

1. 创建 `internal/client/wechat/` 目录
2. 实现 `client.go`, `types.go`, `factory.go`, `errors.go`
3. 在配置文件中添加微信配置
4. 在 `cmd.go` 中初始化

### 添加其他服务

遵循相同的模式：
- Client层封装API调用
- Service层调用Client
- 配置统一管理

## 最佳实践总结

1. ✅ **Client层** → 封装第三方API调用
2. ✅ **Service层** → 业务逻辑编排，调用Client
3. ✅ **配置管理** → 统一配置，环境区分
4. ✅ **错误处理** → 统一错误定义
5. ✅ **初始化** → 应用启动时初始化

所有代码已实现，可以直接使用！

