# 参数验证机制说明

## 参数验证的位置

在 GoFrame 项目中，**参数验证主要在 API 层定义，由框架自动执行**，Controller 层不需要手动验证。

## 验证流程

```
HTTP请求
  ↓
GoFrame框架
  - 解析请求参数
  - 根据API层的v标签自动验证 ← 验证在这里！
  ↓
验证通过 → Controller层方法执行
验证失败 → 直接返回400错误，不执行Controller
```

## API 层定义验证规则

### 1. 创建用户请求验证

```go
// api/user/v1/user.go
type CreateReq struct {
	g.Meta `path:"/user" method:"post" tags:"User" summary:"创建用户"`
	
	// 验证规则通过 v 标签定义
	Name   string `json:"name"  v:"required|length:2,50#用户名不能为空|用户名长度必须在2-50之间" dc:"用户名"`
	Email  string `json:"email" v:"required|email#邮箱不能为空|邮箱格式不正确" dc:"邮箱"`
	Phone  string `json:"phone" v:"phone#手机号格式不正确" dc:"手机号"`
}
```

**验证规则说明**:
- `v:"required"` - 必填字段
- `v:"length:2,50"` - 长度范围
- `v:"email"` - 邮箱格式
- `v:"phone"` - 手机号格式
- `#` 后面是错误消息

### 2. 更新用户请求验证

```go
type UpdateReq struct {
	g.Meta `path:"/user/:id" method:"put" tags:"User" summary:"更新用户"`
	
	Id     uint   `json:"id"    v:"required|min:1#用户ID不能为空|用户ID必须大于0" dc:"用户ID"`
	Name   string `json:"name"  v:"length:2,50#用户名长度必须在2-50之间" dc:"用户名"`
	Email  string `json:"email" v:"email#邮箱格式不正确" dc:"邮箱"`
	Phone  string `json:"phone" v:"phone#手机号格式不正确" dc:"手机号"`
}
```

**验证规则说明**:
- `v:"required|min:1"` - 必填且最小值
- `v:"length:2,50"` - 长度范围（可选字段）
- `v:"email"` - 邮箱格式（可选字段）

### 3. 查询请求验证

```go
type GetByIdReq struct {
	g.Meta `path:"/user/:id" method:"get" tags:"User" summary:"根据ID获取用户"`
	Id     uint `json:"id" v:"required|min:1#用户ID不能为空|用户ID必须大于0" dc:"用户ID"`
}

type GetListReq struct {
	g.Meta   `path:"/users" method:"get" tags:"User" summary:"获取用户列表"`
	Page     int `json:"page"     v:"min:1#页码必须大于0"     d:"1"     dc:"页码"`
	PageSize int `json:"pageSize" v:"min:1|max:100#每页数量必须大于0|每页数量不能超过100" d:"10" dc:"每页数量"`
}
```

**验证规则说明**:
- `v:"min:1"` - 最小值验证
- `v:"max:100"` - 最大值验证
- `d:"1"` - 默认值（如果未提供）

## Controller 层不需要手动验证

### Controller 代码示例

```go
// internal/controller/user/user_v1_create.go
func (c *ControllerV1) Create(ctx context.Context, req *v1.CreateReq) (res *v1.CreateRes, err error) {
	// ❌ 不需要手动验证！
	// if req.Name == "" {
	//     return nil, errors.New("用户名不能为空")
	// }
	
	// ✅ 直接使用，框架已经验证过了
	data := &do.User{
		Name:  &req.Name,   // 这里已经保证Name不为空
		Email: &req.Email,  // 这里已经保证Email格式正确
		Phone: &req.Phone,
	}
	
	id, err := service.UserEnhanced.CreateWithValidation(ctx, data)
	if err != nil {
		return nil, err
	}
	return &v1.CreateRes{Id: id}, nil
}
```

**为什么不需要验证？**
- 框架在调用 Controller 方法之前已经验证过了
- 如果验证失败，Controller 方法根本不会执行
- 直接返回 400 错误给客户端

## 验证执行时机

### 1. 请求到达时

```
HTTP请求: POST /user
Body: {"name":"","email":"invalid-email"}
  ↓
GoFrame框架拦截
  ↓
解析请求体 → v1.CreateReq{Name:"", Email:"invalid-email"}
  ↓
执行验证规则
  - Name: required → ❌ 失败（空字符串）
  - Email: email → ❌ 失败（格式不正确）
  ↓
验证失败 → 返回400错误
{
  "code": 1,
  "message": "用户名不能为空; 邮箱格式不正确",
  "data": null
}
```

### 2. 验证通过后

```
HTTP请求: POST /user
Body: {"name":"张三","email":"zhang@example.com","phone":"13800138000"}
  ↓
GoFrame框架拦截
  ↓
解析请求体 → v1.CreateReq{Name:"张三", Email:"zhang@example.com", Phone:"13800138000"}
  ↓
执行验证规则
  - Name: required|length:2,50 → ✅ 通过
  - Email: required|email → ✅ 通过
  - Phone: phone → ✅ 通过
  ↓
验证通过 → 执行Controller方法
  ↓
Controller.Create() 执行
```

## 验证规则语法

### 基本语法

```
v:"规则1|规则2|规则3#错误消息1|错误消息2|错误消息3"
```

**示例**:
```go
Name string `v:"required|length:2,50#用户名不能为空|用户名长度必须在2-50之间"`
```

**说明**:
- `required` - 规则1
- `length:2,50` - 规则2
- `#` - 分隔符
- `用户名不能为空` - 规则1的错误消息
- `用户名长度必须在2-50之间` - 规则2的错误消息

### 常用验证规则

| 规则 | 说明 | 示例 |
|------|------|------|
| `required` | 必填 | `v:"required#不能为空"` |
| `min:1` | 最小值 | `v:"min:1#必须大于0"` |
| `max:100` | 最大值 | `v:"max:100#不能超过100"` |
| `length:2,50` | 长度范围 | `v:"length:2,50#长度必须在2-50之间"` |
| `email` | 邮箱格式 | `v:"email#邮箱格式不正确"` |
| `phone` | 手机号格式 | `v:"phone#手机号格式不正确"` |
| `integer` | 整数 | `v:"integer#必须是整数"` |
| `float` | 浮点数 | `v:"float#必须是浮点数"` |
| `between:1,100` | 范围 | `v:"between:1,100#必须在1-100之间"` |

### 默认值

```go
Page int `json:"page" v:"min:1#页码必须大于0" d:"1" dc:"页码"`
```

**说明**:
- `d:"1"` - 如果请求中未提供该字段，使用默认值 1
- 适用于可选参数

## 验证错误响应

### 验证失败时的响应格式

```json
{
  "code": 1,
  "message": "用户名不能为空; 邮箱格式不正确",
  "data": null
}
```

**HTTP状态码**: 400 Bad Request

### 多个验证错误

如果多个字段验证失败，错误消息用分号分隔：

```json
{
  "code": 1,
  "message": "用户名不能为空; 邮箱格式不正确; 手机号格式不正确",
  "data": null
}
```

## 完整验证流程示例

### 场景：创建用户

#### 1. 请求（验证失败）

```bash
curl -X POST http://localhost:8000/user \
  -H "Content-Type: application/json" \
  -d '{"name":"","email":"invalid"}'
```

**验证过程**:
```
1. 框架解析请求体
   → v1.CreateReq{Name:"", Email:"invalid", Phone:""}

2. 执行验证规则
   - Name: required → ❌ 失败（空字符串）
   - Email: email → ❌ 失败（格式不正确）
   - Phone: phone → ✅ 通过（可选字段，空字符串不验证）

3. 验证失败，返回错误
   HTTP 400
   {
     "code": 1,
     "message": "用户名不能为空; 邮箱格式不正确",
     "data": null
   }
```

#### 2. 请求（验证通过）

```bash
curl -X POST http://localhost:8000/user \
  -H "Content-Type: application/json" \
  -d '{"name":"张三","email":"zhang@example.com","phone":"13800138000"}'
```

**验证过程**:
```
1. 框架解析请求体
   → v1.CreateReq{Name:"张三", Email:"zhang@example.com", Phone:"13800138000"}

2. 执行验证规则
   - Name: required|length:2,50 → ✅ 通过
   - Email: required|email → ✅ 通过
   - Phone: phone → ✅ 通过

3. 验证通过，执行Controller方法
   → Controller.Create() 执行
   → 返回成功响应
```

## Controller 层的验证职责

### ✅ Controller 层不需要做的

```go
// ❌ 不需要手动验证
func (c *ControllerV1) Create(ctx context.Context, req *v1.CreateReq) (res *v1.CreateRes, err error) {
	// 不需要这些验证！
	if req.Name == "" {
		return nil, errors.New("用户名不能为空")
	}
	if len(req.Name) < 2 || len(req.Name) > 50 {
		return nil, errors.New("用户名长度必须在2-50之间")
	}
	if req.Email == "" {
		return nil, errors.New("邮箱不能为空")
	}
	// ...
}
```

### ✅ Controller 层应该做的

```go
// ✅ 直接使用，框架已经验证过了
func (c *ControllerV1) Create(ctx context.Context, req *v1.CreateReq) (res *v1.CreateRes, err error) {
	// 直接使用，保证数据已经验证过
	data := &do.User{
		Name:  &req.Name,   // 已经保证不为空且长度正确
		Email: &req.Email,  // 已经保证格式正确
		Phone: &req.Phone,
	}
	
	id, err := service.UserEnhanced.CreateWithValidation(ctx, data)
	if err != nil {
		return nil, err
	}
	return &v1.CreateRes{Id: id}, nil
}
```

## 业务逻辑验证 vs 参数验证

### 参数验证（API层）
- **位置**: API 层的 `v` 标签
- **时机**: 框架自动执行，在 Controller 之前
- **内容**: 格式验证、必填验证、长度验证等
- **示例**: 邮箱格式、手机号格式、长度范围

### 业务逻辑验证（Logic层）
- **位置**: Logic 层
- **时机**: Service 层调用 Logic 层时执行
- **内容**: 业务规则验证
- **示例**: 邮箱唯一性、手机号唯一性、删除权限

### 两者配合

```
1. 参数验证（API层）
   - 验证格式、长度等
   - 框架自动执行
   ↓
2. Controller层
   - 参数已经验证通过
   ↓
3. Service层 → Logic层
   - 业务逻辑验证
   - 邮箱唯一性、业务规则等
```

## 总结

### 参数验证的位置

1. **定义位置**: API 层（`api/user/v1/user.go`）
2. **执行位置**: GoFrame 框架（自动执行）
3. **执行时机**: Controller 方法执行之前
4. **验证失败**: 直接返回 400 错误，不执行 Controller

### Controller 层的职责

- ✅ **不需要**手动验证参数
- ✅ **直接使用**请求参数（已经验证过）
- ✅ **专注于**参数转换和调用 Service

### 验证规则

- 在 API 层通过 `v` 标签定义
- 支持多种验证规则（required, email, phone, length等）
- 支持自定义错误消息
- 支持默认值（`d` 标签）

**记住**: 参数验证由框架自动处理，Controller 层不需要手动验证！

