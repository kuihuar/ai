# 各层代码示例

本文档展示各层的完整代码实现，包括所有CRUD操作。

## 1. API层 (api/user/v1/user.go)

```go
package v1

import (
	"hz/internal/model/entity"
	"github.com/gogf/gf/v2/frame/g"
)

// GetByIdReq 根据ID获取用户请求
type GetByIdReq struct {
	g.Meta `path:"/user/:id" method:"get" tags:"User" summary:"根据ID获取用户"`
	Id     uint `json:"id" v:"required|min:1#用户ID不能为空|用户ID必须大于0" dc:"用户ID"`
}

// GetByIdRes 根据ID获取用户响应
type GetByIdRes struct {
	*entity.User
}

// GetListReq 获取用户列表请求
type GetListReq struct {
	g.Meta   `path:"/users" method:"get" tags:"User" summary:"获取用户列表"`
	Page     int `json:"page"     v:"min:1#页码必须大于0"     d:"1"     dc:"页码"`
	PageSize int `json:"pageSize" v:"min:1|max:100#每页数量必须大于0|每页数量不能超过100" d:"10" dc:"每页数量"`
}

// GetListRes 获取用户列表响应
type GetListRes struct {
	List  []*entity.User `json:"list"  dc:"用户列表"`
	Total int            `json:"total" dc:"总数"`
	Page  int            `json:"page"  dc:"当前页码"`
	Size  int            `json:"size"  dc:"每页数量"`
}

// CreateReq 创建用户请求
type CreateReq struct {
	g.Meta `path:"/user" method:"post" tags:"User" summary:"创建用户"`
	Name   string `json:"name"  v:"required|length:2,50#用户名不能为空|用户名长度必须在2-50之间" dc:"用户名"`
	Email  string `json:"email" v:"required|email#邮箱不能为空|邮箱格式不正确" dc:"邮箱"`
	Phone  string `json:"phone" v:"phone#手机号格式不正确" dc:"手机号"`
}

// CreateRes 创建用户响应
type CreateRes struct {
	Id uint `json:"id" dc:"用户ID"`
}

// UpdateReq 更新用户请求
type UpdateReq struct {
	g.Meta `path:"/user/:id" method:"put" tags:"User" summary:"更新用户"`
	Id     uint   `json:"id"    v:"required|min:1#用户ID不能为空|用户ID必须大于0" dc:"用户ID"`
	Name   string `json:"name"  v:"length:2,50#用户名长度必须在2-50之间" dc:"用户名"`
	Email  string `json:"email" v:"email#邮箱格式不正确" dc:"邮箱"`
	Phone  string `json:"phone" v:"phone#手机号格式不正确" dc:"手机号"`
}

// UpdateRes 更新用户响应
type UpdateRes struct {
	Success bool `json:"success" dc:"是否成功"`
}

// DeleteReq 删除用户请求
type DeleteReq struct {
	g.Meta `path:"/user/:id" method:"delete" tags:"User" summary:"删除用户"`
	Id     uint `json:"id" v:"required|min:1#用户ID不能为空|用户ID必须大于0" dc:"用户ID"`
}

// DeleteRes 删除用户响应
type DeleteRes struct {
	Success bool `json:"success" dc:"是否成功"`
}
```

---

## 2. Controller层 (internal/controller/user/)

### user_v1_get_by_id.go

```go
package user

import (
	"context"
	v1 "hz/api/user/v1"
	"hz/internal/service"
)

func (c *ControllerV1) GetById(ctx context.Context, req *v1.GetByIdReq) (res *v1.GetByIdRes, err error) {
	user, err := service.UserEnhanced.GetById(ctx, req.Id)
	if err != nil {
		return nil, err
	}
	return &v1.GetByIdRes{User: user}, nil
}
```

### user_v1_get_list.go

```go
package user

import (
	"context"
	v1 "hz/api/user/v1"
	"hz/internal/service"
)

func (c *ControllerV1) GetList(ctx context.Context, req *v1.GetListReq) (res *v1.GetListRes, err error) {
	users, total, err := service.UserEnhanced.GetList(ctx, req.Page, req.PageSize)
	if err != nil {
		return nil, err
	}
	return &v1.GetListRes{
		List:  users,
		Total: total,
		Page:  req.Page,
		Size:  req.PageSize,
	}, nil
}
```

### user_v1_create.go

```go
package user

import (
	"context"
	v1 "hz/api/user/v1"
	"hz/internal/model/do"
	"hz/internal/service"
)

func (c *ControllerV1) Create(ctx context.Context, req *v1.CreateReq) (res *v1.CreateRes, err error) {
	data := &do.User{
		Name:  &req.Name,
		Email: &req.Email,
		Phone: &req.Phone,
	}
	id, err := service.UserEnhanced.CreateWithValidation(ctx, data)
	if err != nil {
		return nil, err
	}
	return &v1.CreateRes{Id: id}, nil
}
```

### user_v1_update.go

```go
package user

import (
	"context"
	v1 "hz/api/user/v1"
	"hz/internal/model/do"
	"hz/internal/service"
)

func (c *ControllerV1) Update(ctx context.Context, req *v1.UpdateReq) (res *v1.UpdateRes, err error) {
	data := &do.User{}
	if req.Name != "" {
		data.Name = &req.Name
	}
	if req.Email != "" {
		data.Email = &req.Email
	}
	if req.Phone != "" {
		data.Phone = &req.Phone
	}
	err = service.UserEnhanced.UpdateWithValidation(ctx, req.Id, data)
	if err != nil {
		return nil, err
	}
	return &v1.UpdateRes{Success: true}, nil
}
```

### user_v1_delete.go

```go
package user

import (
	"context"
	v1 "hz/api/user/v1"
	"hz/internal/service"
)

func (c *ControllerV1) Delete(ctx context.Context, req *v1.DeleteReq) (res *v1.DeleteRes, err error) {
	err = service.UserEnhanced.DeleteWithValidation(ctx, req.Id)
	if err != nil {
		return nil, err
	}
	return &v1.DeleteRes{Success: true}, nil
}
```

---

## 3. Service层 (internal/service/)

### user.go (基础Service)

```go
package service

import (
	"context"
	"hz/internal/dao"
	"hz/internal/model/do"
	"hz/internal/model/entity"
)

type IUser interface {
	GetById(ctx context.Context, id uint) (user *entity.User, err error)
	GetList(ctx context.Context, page, pageSize int) (users []*entity.User, total int, err error)
	Create(ctx context.Context, data *do.User) (id uint, err error)
	Update(ctx context.Context, id uint, data *do.User) (err error)
	Delete(ctx context.Context, id uint) (err error)
}

type userImpl struct{}

var User = userImpl{}

func (s *userImpl) GetById(ctx context.Context, id uint) (user *entity.User, err error) {
	return dao.User.GetById(ctx, id)
}

func (s *userImpl) GetList(ctx context.Context, page, pageSize int) (users []*entity.User, total int, err error) {
	return dao.User.GetList(ctx, page, pageSize)
}

func (s *userImpl) Create(ctx context.Context, data *do.User) (id uint, err error) {
	return dao.User.Create(ctx, data)
}

func (s *userImpl) Update(ctx context.Context, id uint, data *do.User) (err error) {
	return dao.User.Update(ctx, id, data)
}

func (s *userImpl) Delete(ctx context.Context, id uint) (err error) {
	return dao.User.Delete(ctx, id)
}
```

### user_enhanced.go (增强Service，包含业务逻辑)

```go
package service

import (
	"context"
	"errors"
	"github.com/gogf/gf/v2/frame/g"
	"hz/internal/dao"
	"hz/internal/logic"
	"hz/internal/model/do"
	"hz/internal/model/entity"
)

type IUserEnhanced interface {
	IUser
	CreateWithValidation(ctx context.Context, data *do.User) (id uint, err error)
	UpdateWithValidation(ctx context.Context, id uint, data *do.User) (err error)
	DeleteWithValidation(ctx context.Context, id uint) (err error)
	GetByEmail(ctx context.Context, email string) (user *entity.User, err error)
}

type userEnhancedImpl struct {
	userImpl
}

var UserEnhanced IUserEnhanced = &userEnhancedImpl{}

func (s *userEnhancedImpl) CreateWithValidation(ctx context.Context, data *do.User) (id uint, err error) {
	if err = logic.UserLogic.PrepareUserForCreate(ctx, data); err != nil {
		return 0, err
	}
	return dao.User.Create(ctx, data)
}

func (s *userEnhancedImpl) UpdateWithValidation(ctx context.Context, id uint, data *do.User) (err error) {
	if err = logic.UserLogic.PrepareUserForUpdate(ctx, id, data); err != nil {
		return err
	}
	return dao.User.Update(ctx, id, data)
}

func (s *userEnhancedImpl) DeleteWithValidation(ctx context.Context, id uint) (err error) {
	canDelete, err := logic.UserLogic.CanDeleteUser(ctx, id)
	if err != nil {
		return err
	}
	if !canDelete {
		return errors.New("不允许删除该用户")
	}
	return dao.User.Delete(ctx, id)
}

func (s *userEnhancedImpl) GetByEmail(ctx context.Context, email string) (user *entity.User, err error) {
	err = g.DB().Model("users").Ctx(ctx).Where("email", email).Scan(&user)
	return
}

// 实现基础接口
func (s *userEnhancedImpl) GetById(ctx context.Context, id uint) (user *entity.User, err error) {
	return s.userImpl.GetById(ctx, id)
}

func (s *userEnhancedImpl) GetList(ctx context.Context, page, pageSize int) (users []*entity.User, total int, err error) {
	return s.userImpl.GetList(ctx, page, pageSize)
}

func (s *userEnhancedImpl) Create(ctx context.Context, data *do.User) (id uint, err error) {
	return s.userImpl.Create(ctx, data)
}

func (s *userEnhancedImpl) Update(ctx context.Context, id uint, data *do.User) (err error) {
	return s.userImpl.Update(ctx, id, data)
}

func (s *userEnhancedImpl) Delete(ctx context.Context, id uint) (err error) {
	return s.userImpl.Delete(ctx, id)
}
```

---

## 4. Logic层 (internal/logic/user.go)

```go
package logic

import (
	"context"
	"errors"
	"github.com/gogf/gf/v2/frame/g"
	"hz/internal/dao"
	"hz/internal/model/do"
	"hz/internal/model/entity"
)

type IUserLogic interface {
	ValidateEmailUnique(ctx context.Context, email string, excludeId ...uint) (bool, error)
	ValidatePhoneUnique(ctx context.Context, phone string, excludeId ...uint) (bool, error)
	HashPassword(password string) string
	VerifyPassword(hashedPassword, password string) bool
	PrepareUserForCreate(ctx context.Context, data *do.User) error
	PrepareUserForUpdate(ctx context.Context, id uint, data *do.User) error
	CanDeleteUser(ctx context.Context, id uint) (bool, error)
}

type userLogicImpl struct{}

var UserLogic = userLogicImpl{}

func (l *userLogicImpl) ValidateEmailUnique(ctx context.Context, email string, excludeId ...uint) (bool, error) {
	if email == "" {
		return false, errors.New("邮箱不能为空")
	}
	var user *entity.User
	m := g.DB().Model("users").Ctx(ctx).Where("email", email)
	if len(excludeId) > 0 && excludeId[0] > 0 {
		m = m.WhereNot("id", excludeId[0])
	}
	err := m.Scan(&user)
	if err != nil {
		return false, err
	}
	if user != nil {
		return false, errors.New("邮箱已被使用")
	}
	return true, nil
}

func (l *userLogicImpl) ValidatePhoneUnique(ctx context.Context, phone string, excludeId ...uint) (bool, error) {
	if phone == "" {
		return true, nil
	}
	var user *entity.User
	m := g.DB().Model("users").Ctx(ctx).Where("phone", phone)
	if len(excludeId) > 0 && excludeId[0] > 0 {
		m = m.WhereNot("id", excludeId[0])
	}
	err := m.Scan(&user)
	if err != nil {
		return false, err
	}
	if user != nil {
		return false, errors.New("手机号已被使用")
	}
	return true, nil
}

func (l *userLogicImpl) HashPassword(password string) string {
	return "hashed_" + password // 实际应使用bcrypt
}

func (l *userLogicImpl) VerifyPassword(hashedPassword, password string) bool {
	return hashedPassword == "hashed_"+password
}

func (l *userLogicImpl) PrepareUserForCreate(ctx context.Context, data *do.User) error {
	if data.Email != nil && *data.Email != "" {
		unique, err := l.ValidateEmailUnique(ctx, *data.Email)
		if err != nil {
			return err
		}
		if !unique {
			return errors.New("邮箱已被使用")
		}
	}
	if data.Phone != nil && *data.Phone != "" {
		unique, err := l.ValidatePhoneUnique(ctx, *data.Phone)
		if err != nil {
			return err
		}
		if !unique {
			return errors.New("手机号已被使用")
		}
	}
	if data.Name != nil {
		name := g.Trim(*data.Name)
		data.Name = &name
	}
	if data.Email != nil {
		email := g.StrToLower(*data.Email)
		data.Email = &email
	}
	return nil
}

func (l *userLogicImpl) PrepareUserForUpdate(ctx context.Context, id uint, data *do.User) error {
	user, err := dao.User.GetById(ctx, id)
	if err != nil {
		return err
	}
	if user == nil {
		return errors.New("用户不存在")
	}
	if data.Email != nil && *data.Email != "" {
		unique, err := l.ValidateEmailUnique(ctx, *data.Email, id)
		if err != nil {
			return err
		}
		if !unique {
			return errors.New("邮箱已被其他用户使用")
		}
		email := g.StrToLower(*data.Email)
		data.Email = &email
	}
	if data.Phone != nil && *data.Phone != "" {
		unique, err := l.ValidatePhoneUnique(ctx, *data.Phone, id)
		if err != nil {
			return err
		}
		if !unique {
			return errors.New("手机号已被其他用户使用")
		}
	}
	if data.Name != nil {
		name := g.Trim(*data.Name)
		data.Name = &name
	}
	return nil
}

func (l *userLogicImpl) CanDeleteUser(ctx context.Context, id uint) (bool, error) {
	user, err := dao.User.GetById(ctx, id)
	if err != nil {
		return false, err
	}
	if user == nil {
		return false, errors.New("用户不存在")
	}
	if id == 1 {
		return false, errors.New("不能删除系统管理员")
	}
	return true, nil
}
```

---

## 5. DAO层 (internal/dao/user.go)

```go
package dao

import (
	"context"
	"github.com/gogf/gf/v2/frame/g"
	"hz/internal/model/do"
	"hz/internal/model/entity"
)

type userDao struct{}

var User = userDao{}

func (dao *userDao) GetById(ctx context.Context, id uint) (user *entity.User, err error) {
	err = g.DB().Model("users").Ctx(ctx).Where("id", id).Scan(&user)
	return
}

func (dao *userDao) GetList(ctx context.Context, page, pageSize int) (users []*entity.User, total int, err error) {
	m := g.DB().Model("users").Ctx(ctx)
	total, err = m.Count()
	if err != nil {
		return
	}
	err = m.Page(page, pageSize).OrderDesc("id").Scan(&users)
	return
}

func (dao *userDao) Create(ctx context.Context, data *do.User) (id uint, err error) {
	result, err := g.DB().Model("users").Ctx(ctx).Data(data).InsertAndGetId()
	if err != nil {
		return 0, err
	}
	return uint(result), nil
}

func (dao *userDao) Update(ctx context.Context, id uint, data *do.User) (err error) {
	updateData := g.Map{}
	if data.Name != nil {
		updateData["name"] = *data.Name
	}
	if data.Email != nil {
		updateData["email"] = *data.Email
	}
	if data.Phone != nil {
		updateData["phone"] = *data.Phone
	}
	if len(updateData) == 0 {
		return nil
	}
	_, err = g.DB().Model("users").Ctx(ctx).Where("id", id).Data(updateData).Update()
	return
}

func (dao *userDao) Delete(ctx context.Context, id uint) (err error) {
	_, err = g.DB().Model("users").Ctx(ctx).Where("id", id).Delete()
	return
}
```

---

## 6. Model层

### entity/user.go

```go
package entity

type User struct {
	Id        uint   `json:"id"        description:"用户ID"`
	Name      string `json:"name"      description:"用户名"`
	Email     string `json:"email"     description:"邮箱"`
	Phone     string `json:"phone"     description:"手机号"`
	CreatedAt string `json:"createdAt" description:"创建时间"`
	UpdatedAt string `json:"updatedAt" description:"更新时间"`
}
```

### do/user.go

```go
package do

import "github.com/gogf/gf/v2/frame/g"

type User struct {
	g.Meta `orm:"table:users, do:true"`
	Id     *uint   `orm:"id,primary"       json:"id"`
	Name   *string `orm:"name"             json:"name"`
	Email  *string `orm:"email"            json:"email"`
	Phone  *string `orm:"phone"            json:"phone"`
}
```

---

## 总结

以上展示了完整的各层代码实现。关键点：

1. **API层**: 定义接口规范，不包含业务逻辑
2. **Controller层**: 处理HTTP请求，参数转换
3. **Service层**: 业务逻辑编排，协调Logic和DAO
4. **Logic层**: 复杂业务逻辑，业务规则验证
5. **DAO层**: 数据访问，SQL操作
6. **Model层**: 数据模型定义

各层职责清晰，依赖关系明确，易于维护和扩展。

