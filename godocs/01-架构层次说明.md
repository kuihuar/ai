# 架构层次说明

## 项目分层架构

本项目采用**分层架构**设计，各层职责明确，依赖关系清晰。

## 层次结构

```
┌─────────────────────────────────────────┐
│         API Layer (api/)                │  接口定义层
│  - 定义请求/响应结构体                   │
│  - 定义路由元信息                        │
└─────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────┐
│      Controller Layer (controller/)     │  控制器层
│  - 处理HTTP请求                          │
│  - 参数验证和转换                        │
│  - 调用Service层                         │
└─────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────┐
│       Service Layer (service/)          │  服务层
│  - 业务逻辑编排                          │
│  - 调用Logic层和DAO层                    │
│  - 事务管理（如需要）                    │
└─────────────────────────────────────────┘
         ↓                    ↓
┌─────────────────┐  ┌──────────────────┐
│  Logic Layer    │  │   DAO Layer      │
│  (logic/)       │  │   (dao/)         │
│  - 复杂业务逻辑  │  │   - 数据访问     │
│  - 业务规则验证  │  │   - SQL操作      │
│  - 数据预处理    │  │   - 数据库交互   │
└─────────────────┘  └──────────────────┘
                            ↓
┌─────────────────────────────────────────┐
│       Model Layer (model/)              │  模型层
│  - entity: 实体对象（业务逻辑使用）      │
│  - do: 数据对象（数据库操作使用）        │
└─────────────────────────────────────────┘
```

## 各层职责

### 1. API Layer (api/)
**职责**: 定义接口规范
- 定义请求结构体（Req）
- 定义响应结构体（Res）
- 使用 `g.Meta` 标签定义路由信息
- 参数验证规则

**特点**: 
- 不包含业务逻辑
- 不依赖其他层
- 可被Controller层实现

### 2. Controller Layer (controller/)
**职责**: 处理HTTP请求
- 接收HTTP请求
- 参数验证（框架自动验证）
- 参数转换（API层结构 -> DO层结构）
- 调用Service层
- 返回HTTP响应

**特点**:
- 依赖API层和Service层
- 不直接操作数据库
- 不包含复杂业务逻辑

### 3. Service Layer (service/)
**职责**: 业务逻辑编排
- 协调Logic层和DAO层
- 业务逻辑编排
- 事务管理（如需要）
- 数据转换（DO <-> Entity）

**特点**:
- 依赖Logic层和DAO层
- 不直接操作数据库
- 可被多个Controller复用

### 4. Logic Layer (logic/)
**职责**: 复杂业务逻辑
- 业务规则验证
- 数据预处理和格式化
- 复杂计算逻辑
- 业务规则检查

**特点**:
- 可能依赖DAO层（用于验证）
- 不直接返回HTTP响应
- 可被多个Service复用

### 5. DAO Layer (dao/)
**职责**: 数据访问
- 封装数据库操作
- SQL查询构建
- 数据持久化
- 数据库连接管理

**特点**:
- 只依赖Model层
- 不包含业务逻辑
- 可被多个Service复用

### 6. Model Layer (model/)
**职责**: 数据模型定义
- **entity**: 实体对象，用于业务逻辑
- **do**: 数据对象，用于数据库操作

**特点**:
- 不依赖任何层
- 纯数据结构定义

## 依赖关系规则

### 依赖方向（单向）
```
API → Controller → Service → Logic/DAO → Model
```

### 依赖规则
1. **上层可以依赖下层，下层不能依赖上层**
2. **同层之间尽量避免依赖**
3. **Logic层和DAO层可以互相调用（但Logic通常调用DAO）**
4. **Model层不依赖任何层**

### 禁止的依赖
- ❌ Controller 直接调用 DAO
- ❌ Service 直接调用 Controller
- ❌ Logic 直接调用 Controller
- ❌ DAO 依赖 Service

## 数据流转

### 创建用户示例

```
1. HTTP请求
   POST /user
   Body: {"name":"张三","email":"zhang@example.com"}
   ↓
2. Controller层 (user_v1_create.go)
   - 接收请求参数 (v1.CreateReq)
   - 转换为DO对象 (do.User)
   - 调用 service.UserEnhanced.CreateWithValidation()
   ↓
3. Service层 (user_enhanced.go)
   - 调用 logic.UserLogic.PrepareUserForCreate()
   - 调用 dao.User.Create()
   ↓
4. Logic层 (user.go)
   - ValidateEmailUnique() - 验证邮箱唯一性
   - ValidatePhoneUnique() - 验证手机号唯一性
   - 数据清理和格式化
   ↓
5. DAO层 (user.go)
   - 执行SQL: INSERT INTO users ...
   ↓
6. 数据库
   - 持久化数据
   ↓
7. 返回路径（反向）
   DAO → Service → Controller → HTTP响应
```

## 优势

1. **职责清晰**: 每层职责单一，易于理解
2. **易于测试**: 各层可独立测试
3. **易于维护**: 修改某层不影响其他层
4. **易于扩展**: 新增功能只需在对应层添加代码
5. **代码复用**: Logic和DAO可被多个Service复用

