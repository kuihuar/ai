# 运行流程文档

## 应用启动流程

### 1. 程序入口 (`main.go`)

```go
func main() {
    cmd.Main.Run(gctx.GetInitCtx())
}
```

- 导入 `internal/packed` 包（资源打包）
- 调用 `cmd.Main.Run()` 启动应用
- 使用 GoFrame 的上下文初始化

### 2. 命令初始化 (`internal/cmd/cmd.go`)

```go
Main = gcmd.Command{
    Name:  "main",
    Usage: "main",
    Brief: "start http server",
    Func: func(ctx context.Context, parser *gcmd.Parser) (err error) {
        // 启动 HTTP 服务器
    },
}
```

**执行步骤**:
1. 获取 GoFrame 服务器实例: `g.Server()`
2. 创建路由组，注册中间件: `ghttp.MiddlewareHandlerResponse`
3. 绑定控制器: `hello.NewV1()`
4. 启动服务器: `s.Run()`

### 3. 路由注册

- **路由组**: `/`
- **中间件**: `ghttp.MiddlewareHandlerResponse` (统一响应处理)
- **控制器**: `hello.NewV1()` 实现 `IHelloV1` 接口

### 4. 请求处理流程

当客户端发起 `GET /hello` 请求时：

```
1. HTTP 请求到达
   ↓
2. GoFrame 路由匹配
   ↓
3. 中间件处理 (MiddlewareHandlerResponse)
   ↓
4. 路由到 Controller: hello.ControllerV1.Hello()
   ↓
5. 执行控制器方法
   - 从上下文获取请求对象
   - 写入响应: "Hello World!"
   ↓
6. 中间件处理响应
   ↓
7. 返回 HTTP 响应给客户端
```

## 代码执行路径

### Hello API 完整调用链

```
main.go
  └─> cmd.Main.Run()
       └─> cmd.go: Func()
            └─> g.Server().Group("/")
                 └─> group.Bind(hello.NewV1())
                      └─> hello.NewV1() 返回 ControllerV1
                           └─> 实现 IHelloV1 接口
                                └─> Hello() 方法
                                     └─> hello_v1_hello.go: Hello()
                                          └─> 处理请求并返回响应
```

### 关键文件说明

1. **`api/hello/v1/hello.go`**
   - 定义 `HelloReq` 和 `HelloRes` 结构体
   - `HelloReq` 包含路由元信息: `path:"/hello" method:"get"`

2. **`internal/controller/hello/hello_new.go`**
   - 创建 `ControllerV1` 实例
   - 实现 `hello.IHelloV1` 接口

3. **`internal/controller/hello/hello_v1_hello.go`**
   - 实现 `Hello()` 方法
   - 处理具体业务逻辑

## 配置加载流程

1. GoFrame 自动加载配置文件
2. 默认配置文件路径: `manifest/config/config.yaml`
3. 配置项包括:
   - 服务器地址和端口
   - 日志级别
   - 数据库连接

## 部署流程

### 本地开发运行

```bash
# 方式1: 直接运行
go run main.go

# 方式2: 编译后运行
go build -o bin/main main.go
./bin/main
```

### Docker 构建

```bash
# 使用 Makefile
make docker

# 或手动构建
# 1. 编译 Linux 二进制文件
GOOS=linux GOARCH=amd64 go build -o temp/linux_amd64/main main.go

# 2. 构建 Docker 镜像
docker build -f manifest/docker/Dockerfile -t hz:latest .
```

### Kubernetes 部署

```bash
# 使用 Kustomize
kubectl apply -k manifest/deploy/kustomize/overlays/develop
```

## 请求示例

### 访问 Hello API

```bash
# 使用 curl
curl http://localhost:8000/hello

# 响应
Hello World!
```

### 访问 Swagger 文档

```bash
# OpenAPI 规范
http://localhost:8000/api.json

# Swagger UI
http://localhost:8000/swagger
```

## 扩展点

项目预留了以下扩展点：

1. **Service 层** (`internal/service/`)
   - 添加业务逻辑服务

2. **DAO 层** (`internal/dao/`)
   - 添加数据访问对象

3. **Logic 层** (`internal/logic/`)
   - 添加复杂业务逻辑

4. **Model 层** (`internal/model/`)
   - 添加数据模型定义

5. **常量定义** (`internal/consts/`)
   - 添加项目常量

## 中间件说明

当前使用的中间件：
- **`ghttp.MiddlewareHandlerResponse`**: 
  - 统一处理 HTTP 响应格式
  - 自动处理错误响应
  - 标准化 API 响应结构

## 日志系统

- 日志级别: `all` (所有级别)
- 输出: 标准输出 (`stdout: true`)
- 配置位置: `manifest/config/config.yaml`

