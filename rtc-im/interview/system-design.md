# 系统设计面试题

RTC 和 IM 相关的系统设计面试题和解答思路。

## 目录

- [IM 系统设计](#im-系统设计)
- [视频会议系统](#视频会议系统)
- [直播系统](#直播系统)
- [实时游戏系统](#实时游戏系统)

---

## IM 系统设计

### 题目：设计一个支持千万级用户的 IM 系统

#### 需求分析

**功能需求：**
- 单聊、群聊
- 消息类型：文本、图片、文件、语音、视频
- 消息状态：发送中、已发送、已读
- 在线状态
- 离线消息
- 消息推送

**非功能需求：**
- 支持千万级用户
- 消息延迟 < 100ms
- 消息可靠性 99.99%
- 高可用性

#### 系统架构

```
┌─────────────────────────────────────────┐
│           客户端层                        │
│  iOS / Android / Web                     │
└──────────────┬──────────────────────────┘
               │
┌──────────────▼──────────────────────────┐
│         接入层 (Gateway)                  │
│  ┌──────────┐  ┌──────────┐            │
│  │ WS Gateway│  │ WS Gateway│  ...      │
│  └──────────┘  └──────────┘            │
│      负载均衡 (Nginx/HAProxy)            │
└──────────────┬──────────────────────────┘
               │
┌──────────────▼──────────────────────────┐
│         业务层                            │
│  ┌──────────┐  ┌──────────┐            │
│  │ 消息服务  │  │ 用户服务  │            │
│  └──────────┘  └──────────┘            │
│  ┌──────────┐  ┌──────────┐            │
│  │ 群组服务  │  │ 推送服务  │            │
│  └──────────┘  └──────────┘            │
└──────────────┬──────────────────────────┘
               │
┌──────────────▼──────────────────────────┐
│         存储层                            │
│  ┌──────────┐  ┌──────────┐            │
│  │  MySQL   │  │  Redis   │            │
│  │ (分库分表)│  │ (缓存)   │            │
│  └──────────┘  └──────────┘            │
│  ┌──────────┐  ┌──────────┐            │
│  │ 消息队列  │  │ 对象存储  │            │
│  │ (Kafka)  │  │ (OSS)    │            │
│  └──────────┘  └──────────┘            │
└─────────────────────────────────────────┘
```

#### 核心设计

**1. 消息流程**

```
发送方 → Gateway → 消息服务 → 消息队列
                              ↓
接收方 ← Gateway ← 推送服务 ← 消息队列
```

**2. 存储设计**

- **消息存储**：MySQL 分库分表
  - 按用户 ID 分片
  - 按时间分表（按月）
  - 冷热数据分离

- **在线状态**：Redis
  - Key: `user:online:{userID}`
  - Value: 最后心跳时间
  - TTL: 60 秒

- **离线消息**：Redis + MySQL
  - Redis: 最近离线消息
  - MySQL: 历史离线消息

**3. 扩展性设计**

- **水平扩展**：无状态服务
- **数据库分片**：按用户 ID
- **缓存分层**：本地缓存 + Redis
- **消息队列**：解耦服务

#### 关键技术点

1. **消息可靠性**
   - 消息确认机制
   - 消息重传
   - 消息去重

2. **消息顺序性**
   - 消息序列号
   - 分区有序

3. **高并发**
   - 连接池
   - 异步处理
   - 限流降级

---

## 视频会议系统

### 题目：设计一个支持 1000 人同时在线视频会议系统

#### 需求分析

**功能需求：**
- 多人视频会议
- 屏幕共享
- 录制功能
- 聊天功能

**非功能需求：**
- 支持 1000 人
- 延迟 < 200ms
- 音视频质量稳定

#### 系统架构

```
┌─────────────────────────────────────────┐
│           客户端层                        │
│  WebRTC Client                          │
└──────────────┬──────────────────────────┘
               │
┌──────────────▼──────────────────────────┐
│         信令服务器                        │
│  ┌──────────┐  ┌──────────┐            │
│  │ 信令服务  │  │ 房间管理  │            │
│  └──────────┘  └──────────┘            │
└──────────────┬──────────────────────────┘
               │
┌──────────────▼──────────────────────────┐
│         媒体服务器                        │
│  ┌──────────┐  ┌──────────┐            │
│  │   SFU    │  │   MCU   │            │
│  └──────────┘  └──────────┘            │
│  ┌──────────┐  ┌──────────┐            │
│  │  录制服务  │  │  转码服务  │            │
│  └──────────┘  └──────────┘            │
└──────────────┬──────────────────────────┘
               │
┌──────────────▼──────────────────────────┐
│         基础设施                          │
│  STUN/TURN 服务器                        │
│  监控和日志                              │
└─────────────────────────────────────────┘
```

#### 核心设计

**1. 架构选择：SFU vs MCU**

- **SFU (Selective Forwarding Unit)**
  - 适合大规模会议
  - 低延迟
  - 服务器压力小

- **MCU (Multipoint Control Unit)**
  - 适合小规模会议
  - 客户端简单
  - 服务器压力大

**选择：SFU 架构**

**2. 媒体流转发**

```
客户端1 → SFU → 客户端2, 客户端3, ...
客户端2 → SFU → 客户端1, 客户端3, ...
```

**3. 录制功能**

- 服务端录制
- 混流后录制
- 存储到对象存储

#### 关键技术点

1. **网络优化**
   - TURN 服务器部署
   - 就近接入
   - 带宽自适应

2. **性能优化**
   - 硬件加速
   - 多线程处理
   - 负载均衡

3. **质量保证**
   - 网络自适应
   - 丢包恢复
   - 延迟优化

---

## 直播系统

### 题目：设计一个支持百万级并发的直播系统

#### 需求分析

**功能需求：**
- 直播推流
- 直播观看
- 弹幕互动
- 礼物打赏

**非功能需求：**
- 支持百万级并发
- 延迟 < 3 秒
- 高可用性

#### 系统架构

```
┌─────────────────────────────────────────┐
│           推流端                          │
│  主播客户端 (RTMP/WebRTC)                │
└──────────────┬──────────────────────────┘
               │
┌──────────────▼──────────────────────────┐
│         推流服务器                        │
│  ┌──────────┐  ┌──────────┐            │
│  │ RTMP服务 │  │ 转码服务  │            │
│  └──────────┘  └──────────┘            │
└──────────────┬──────────────────────────┘
               │
┌──────────────▼──────────────────────────┐
│         CDN 网络                          │
│  边缘节点 (Edge Nodes)                    │
└──────────────┬──────────────────────────┘
               │
┌──────────────▼──────────────────────────┐
│         拉流端                            │
│  观众客户端 (HLS/HTTP-FLV)               │
└─────────────────────────────────────────┘
```

#### 核心设计

**1. 推流流程**

```
主播 → RTMP 推流 → 推流服务器 → 转码 → CDN
```

**2. 拉流流程**

```
CDN → 边缘节点 → 观众客户端
```

**3. 弹幕系统**

```
观众 → 弹幕服务 → 消息队列 → 推送给所有观众
```

#### 关键技术点

1. **CDN 加速**
   - 就近分发
   - 减少延迟
   - 降低带宽成本

2. **转码服务**
   - 多码率转码
   - 自适应码率
   - 硬件加速

3. **弹幕系统**
   - 消息队列
   - 限流控制
   - 实时推送

---

## 实时游戏系统

### 题目：设计一个实时多人游戏系统

#### 需求分析

**功能需求：**
- 多人实时对战
- 状态同步
- 延迟补偿

**非功能需求：**
- 延迟 < 50ms
- 状态一致性
- 反作弊

#### 系统架构

```
┌─────────────────────────────────────────┐
│           游戏客户端                      │
│  游戏逻辑 + 网络通信                      │
└──────────────┬──────────────────────────┘
               │
┌──────────────▼──────────────────────────┐
│         游戏服务器                        │
│  ┌──────────┐  ┌──────────┐            │
│  │ 房间服务  │  │ 状态同步  │            │
│  └──────────┘  └──────────┘            │
│  ┌──────────┐  ┌──────────┐            │
│  │ 反作弊   │  │ 匹配服务  │            │
│  └──────────┘  └──────────┘            │
└─────────────────────────────────────────┘
```

#### 核心设计

**1. 状态同步**

- **客户端预测**
- **服务器权威**
- **延迟补偿**

**2. 网络协议**

- UDP（低延迟）
- 自定义协议
- 消息压缩

**3. 反作弊**

- 服务器验证
- 行为检测
- 数据加密

---

## 设计思路总结

### 通用设计原则

1. **分层架构**
   - 接入层
   - 业务层
   - 存储层

2. **水平扩展**
   - 无状态服务
   - 负载均衡
   - 数据分片

3. **高可用**
   - 多副本
   - 故障转移
   - 降级策略

4. **性能优化**
   - 缓存
   - 异步处理
   - 连接池

### 面试回答技巧

1. **需求澄清**
   - 明确功能需求
   - 明确非功能需求
   - 明确约束条件

2. **架构设计**
   - 画出架构图
   - 说明设计理由
   - 考虑扩展性

3. **细节讨论**
   - 存储设计
   - 网络协议
   - 性能优化

4. **权衡分析**
   - 不同方案的对比
   - 优缺点分析
   - 适用场景

---

## 参考资料

- [系统设计面试指南](https://github.com/)
- [分布式系统设计](https://en.wikipedia.org/wiki/Distributed_computing)
- [高并发系统设计](https://github.com/)

